{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h4 class="mb-0 text-primary fw-bold">학생 개별 등록</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- 1. 학교 선택 영역 (검색 기능) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">학교 선택 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <!-- 사용자에게 보이는 학교명 (수정 불가) -->
                            <input type="text" id="schoolNameDisplay" class="form-control" placeholder="우측 버튼으로 학교를 검색하세요" readonly required>
                            <!-- 실제 서버로 전송될 학교 DB ID (숨겨짐) -->
                            <input type="hidden" name="school_select_id" id="schoolIdInput">
                            <!-- 검색 버튼 -->
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#schoolSearchModal">
                                <i class="bi bi-search"></i> 학교 찾기
                            </button>
                        </div>
                    </div>

                    <!-- 2. 기존 입력 필드 -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">학년</label>
                            {{ form.grade }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">반</label>
                            {{ form.class_no }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">번호</label>
                            {{ form.number }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">이름</label>
                            {{ form.name }}
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">등록하기</button>
                        <a href="{% url 'mypage' %}" class="btn btn-secondary">취소</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- [팝업] 학교 검색 모달 -->
<div class="modal fade" id="schoolSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">학교 검색</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="schoolSearchInput" class="form-control" placeholder="학교명을 입력하세요 (예: 가락)">
                    <button class="btn btn-primary" type="button" onclick="searchSchool()">검색</button>
                </div>
                <!-- 검색 결과가 나오는 곳 -->
                <div class="list-group" id="schoolResultList" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted p-3">학교명을 입력하고 검색하세요.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 검색 기능 스크립트 -->
<script>
function searchSchool() {
    const query = document.getElementById('schoolSearchInput').value;
    if (query.length < 2) {
        alert("두 글자 이상 입력해주세요.");
        return;
    }

    // 서버에 검색 요청 (AJAX)
    fetch(`/accounts/search/school/?q=${query}`)
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('schoolResultList');
            list.innerHTML = ''; // 기존 목록 비우기

            if (data.results.length === 0) {
                list.innerHTML = '<div class="text-center text-muted p-3">검색 결과가 없습니다.</div>';
                return;
            }

            // 검색 결과 리스트 만들기
            data.results.forEach(school => {
                const item = document.createElement('button');
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <span class="fw-bold">${school.name}</span>
                        <small class="text-muted ms-2">${school.office}</small>
                    </div>
                    <span class="badge bg-secondary rounded-pill">선택</span>
                `;
                // 목록 클릭 시 동작
                item.onclick = () => {
                    document.getElementById('schoolNameDisplay').value = school.name; // 화면 표시용
                    document.getElementById('schoolIdInput').value = school.id;       // 서버 전송용 ID
                    
                    // 모달 닫기 (Bootstrap 5 방식)
                    const modalEl = document.getElementById('schoolSearchModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                };
                list.appendChild(item);
            });
        });
}

// 엔터키로도 검색 가능하게
document.getElementById('schoolSearchInput').addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        searchSchool();
    }
});
</script>
{% endblock %}