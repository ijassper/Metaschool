{% extends 'base.html' %}

{% block content %}
<!-- ë¡œë”© ì¤‘ í™”ë©´ (í‰ì†Œì—” ìˆ¨ê¹€) -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="text-white fw-bold">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</h4>
    <p class="text-white-50">ì‹¤í–‰ì—¬ë¶€ê°€ '1'ì¸ í•™ìƒë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
</div>

<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-success mb-0"><i class="bi bi-robot"></i> í•™ìƒê²°ê³¼ë¬¼ AI ë¶„ì„</h3>
        <span class="badge bg-secondary fs-6"><i class="bi bi-file-earmark-excel"></i> íŒŒì¼: {{ filename }}</span>
    </div>
    
    <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
    <div class="alert alert-danger">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" onsubmit="showLoading()">
        {% csrf_token %}
        <div class="row">
            <!-- ì™¼ìª½: ë°ì´í„° ì„ íƒ -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-3 h-100">
                    <div class="card-header bg-light fw-bold">1. AIì—ê²Œ ë³´ì—¬ì¤„ ë°ì´í„°</div>
                    <div class="card-body" style="max-height: 800px; overflow-y: auto;">
                        <p class="small text-muted mb-2">
                            * 'ì´ë¦„'ì„ ì„ íƒí•˜ë©´ AIê°€ í•™ìƒ ì´ë¦„ì„ ì¸ì‹í•©ë‹ˆë‹¤.<br>
                            * 'ì‹¤í–‰ì—¬ë¶€' ì—´ì´ ìˆê³  ê°’ì´ 1ì´ë©´ ì‹¤í–‰, 0ì´ë©´ ê±´ë„ˆëœë‹ˆë‹¤.
                        </p>
                        {% for col in columns %}
                        <div class="form-check py-1">
                            <input class="form-check-input" type="checkbox" name="selected_cols" value="{{ col }}" id="col_{{ forloop.counter }}">
                            <label class="form-check-label" for="col_{{ forloop.counter }}">{{ col }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: í”„ë¡¬í”„íŠ¸ ì„¤ì • (ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥) -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                        <span>2. ë¶„ì„ ì„¤ì • (í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§)</span>
                    </div>
                    <div class="card-body">
                        
                        <!-- ê²°ê³¼ ì—´ ì´ë¦„ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê²°ê³¼ë¥¼ ì €ì¥í•  ì—´ ì´ë¦„</label>
                            <input type="text" name="target_col_name" class="form-control" value="AI_ìƒê¸°ë¶€_ê²°ê³¼">
                        </div>

                        <!-- ì˜¨ë„ ì¡°ì ˆ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold d-flex justify-content-between">
                                <span>ì°½ì˜ì„± (0.1 ~ 1.0)</span>
                                <span id="tempValue" class="text-primary">0.7</span>
                            </label>
                            <input type="range" name="temperature" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7" oninput="document.getElementById('tempValue').innerText = this.value">
                        </div>

                        <!-- â˜… í…œí”Œë¦¿ ì„ íƒ -->
                        <div class="mb-4 p-3 bg-light rounded border">
                            <label class="form-label fw-bold text-primary"><i class="bi bi-magic"></i> í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</label>
                            <select class="form-select" id="templateSelect" onchange="applyTemplate()">
                                <option value="">-- ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì˜ˆì‹œ ì„ íƒ --</option>
                                {% for t in prompt_templates %}
                                    <option value="{{ t.id }}">{{ t.title }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">ì„ íƒí•˜ë©´ ì•„ë˜ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
                        </div>

                        <hr>

                        <!-- â˜… ë¶„í• ëœ ì…ë ¥ í•„ë“œë“¤ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">í”„ë¡¬í”„íŠ¸ ë§¥ë½</label>
                            <input type="text" name="p_context" id="p_context" class="form-control" placeholder="ì˜ˆ: ê³ ë“±í•™êµ 1í•™ë…„ í†µí•©ì‚¬íšŒ ìˆ˜ì—… ì‹œê°„ì„.">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">AIì˜ ì—­í• </label>
                            <input type="text" name="p_role" id="p_role" class="form-control" placeholder="ì˜ˆ: 20ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ êµì‚¬">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">AIê°€ í•  ì¼</label>
                            <textarea name="p_task" id="p_task" class="form-control" rows="3" placeholder="ì˜ˆ: ê¸°ì´ˆ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ ê°•ì ì„ ë¶„ì„í•˜ì—¬ ìƒê¸°ë¶€ ë¬¸êµ¬ ì‘ì„±"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ì›í•˜ëŠ” ê²°ê³¼ê°’ ì˜ˆì‹œ</label>
                            <textarea name="p_example" id="p_example" class="form-control" rows="3" placeholder="ì˜ˆ: ~~í•œ í™œë™ì„ í†µí•´ ~~í•œ ì—­ëŸ‰ì„ ë³´ì—¬ì¤Œ."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ì›í•˜ëŠ” ë¶„ëŸ‰</label>
                            <input type="text" name="p_length" id="p_length" class="form-control" placeholder="ì˜ˆ: ê³µë°± í¬í•¨ 500ì ë‚´ì™¸, ê°œì¡°ì‹ ì„œìˆ í˜•">
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg mt-3 fw-bold">
                            <i class="bi bi-play-circle-fill"></i> ë¶„ì„ ì‹¤í–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ë°ì´í„° ì „ë‹¬ ë° ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // Django ë°ì´í„°ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ë³€í™˜ (ìë™ ì±„ìš°ê¸°ìš©)
    const templates = {
        {% for t in prompt_templates %}
        "{{ t.id }}": {
            context: `{{ t.context|escapejs }}`,
            role: `{{ t.role|escapejs }}`,
            task: `{{ t.task|escapejs }}`,
            example: `{{ t.output_example|escapejs }}`,
            length: `{{ t.length|escapejs }}`
        },
        {% endfor %}
    };

    function applyTemplate() {
        const select = document.getElementById('templateSelect');
        const id = select.value;
        
        if (id && templates[id]) {
            const t = templates[id];
            document.getElementById('p_context').value = t.context;
            document.getElementById('p_role').value = t.role;
            document.getElementById('p_task').value = t.task;
            document.getElementById('p_example').value = t.example;
            document.getElementById('p_length').value = t.length;
        } else {
            // ì„ íƒ í•´ì œ ì‹œ ë¹„ìš°ê¸° (ì›í•˜ë©´ ì£¼ì„ ì²˜ë¦¬)
            // document.getElementById('p_context').value = '';
            // ...
        }
    }
    
    function showLoading() {
        // ì²´í¬ë°•ìŠ¤ ì„ íƒ í™•ì¸
        const checkboxes = document.querySelectorAll('input[name="selected_cols"]:checked');
        if (checkboxes.length === 0) {
            alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë°ì´í„°(ì¬ë£Œ)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
            event.preventDefault();
            return;
        }

        // ë¡œë”© í™”ë©´ í‘œì‹œ
        document.getElementById('loadingOverlay').classList.remove('d-none');

        // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ê°ì§€ ì‹œì‘
        checkDownloadCookie();
    }

    // ì¿ í‚¤ í™•ì¸ í•¨ìˆ˜
    function checkDownloadCookie() {
        const checkInterval = setInterval(function() {
            if (document.cookie.indexOf('download_complete=true') !== -1) {
                // 1. ì™„ë£Œ ì‹ í˜¸ ê°ì§€ë¨!
                clearInterval(checkInterval); // ê°ì‹œ ì¢…ë£Œ
                
                // 2. ë¡œë”© í™”ë©´ ë„ê¸°
                document.getElementById('loadingOverlay').classList.add('d-none');
                
                // 3. ì¿ í‚¤ ì‚­ì œ (ë‹¤ìŒ ë²ˆì„ ìœ„í•´)
                document.cookie = "download_complete=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                
                // 4. ì„±ê³µ ì•Œë¦¼
                alert("âœ… ë¶„ì„ ë° ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                
                // (ì„ íƒì‚¬í•­) 1ë‹¨ê³„ë¡œ ëŒì•„ê°€ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // window.location.href = "{% url 'ai_generator_step1' %}";
            }
        }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸
    }
</script>
{% endblock %}