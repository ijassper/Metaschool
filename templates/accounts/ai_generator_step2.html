{% extends 'base.html' %}

{% block content %}
<!-- ë¡œë”© ì¤‘ í™”ë©´ (í‰ì†Œì—” ìˆ¨ê¹€) -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-90 d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <h3 class="text-white fw-bold mb-3">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</h3>
    
    <!-- ì§„í–‰ë¥  ë°” -->
    <div class="progress w-50 mb-2" style="height: 25px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%">0%</div>
    </div>
    <div class="text-white fs-5">
        <span id="currentCount">0</span> / <span id="totalCount">0</span> ëª… ì²˜ë¦¬ ì¤‘
    </div>
    <p class="text-white-50 small mt-3">ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”. 200ëª… ê¸°ì¤€ ì•½ 40~50ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
</div>

<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-success mb-0"><i class="bi bi-robot"></i> í•™ìƒê²°ê³¼ë¬¼ AI ë¶„ì„</h3>
        <span class="badge bg-secondary fs-6"><i class="bi bi-file-earmark-excel"></i> íŒŒì¼: {{ filename }}</span>
    </div>
    
    <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
    <div class="alert alert-danger">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    <form id="aiForm" onsubmit="startBatchProcess(event)">
        {% csrf_token %}
        <div class="row">
            <!-- ì™¼ìª½: ë°ì´í„° ì„ íƒ -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-3 h-100">
                    <div class="card-header bg-light fw-bold">1. AIì—ê²Œ ë³´ì—¬ì¤„ ë°ì´í„°</div>
                    <div class="card-body" style="max-height: 800px; overflow-y: auto;">
                        <p class="small text-muted mb-2">
                            * 'ì´ë¦„'ì„ ì„ íƒí•˜ë©´ AIê°€ í•™ìƒ ì´ë¦„ì„ ì¸ì‹í•©ë‹ˆë‹¤.<br>
                            * 'ì‹¤í–‰ì—¬ë¶€' ì—´ì´ ìˆê³  ê°’ì´ 1ì´ë©´ ì‹¤í–‰, 0ì´ë©´ ê±´ë„ˆëœë‹ˆë‹¤.
                        </p>
                        {% for col in columns %}
                        <div class="form-check py-1">
                            <input class="form-check-input" type="checkbox" name="selected_cols" value="{{ col }}" id="col_{{ forloop.counter }}">
                            <label class="form-check-label" for="col_{{ forloop.counter }}">{{ col }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: í”„ë¡¬í”„íŠ¸ ì„¤ì • (ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥) -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                        <span>2. ë¶„ì„ ì„¤ì • (í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§)</span>
                    </div>
                    <div class="card-body">
                        
                        <!-- [ìˆ˜ì •] ê²°ê³¼ë¥¼ ì €ì¥í•  ì—´ ì´ë¦„ (ì…€ë ‰íŠ¸ ë°•ìŠ¤ + ì§ì ‘ ì…ë ¥) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">ê²°ê³¼ë¥¼ ì €ì¥í•  ì—´ ì´ë¦„</label>
                            <div class="input-group">
                                <select class="form-select" id="targetColSelect" onchange="toggleTargetColInput()">
                                    <option value="new">âœ¨ [ìƒˆë¡œ ë§Œë“¤ê¸°] (ì§ì ‘ ì…ë ¥)</option>
                                    <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                    {% for col in columns %}
                                        <option value="{{ col }}">{{ col }} (ë®ì–´ì“°ê¸°)</option>
                                    {% endfor %}
                                </select>
                                <!-- ì§ì ‘ ì…ë ¥ í•„ë“œ (ê¸°ë³¸ê°’: AI_ìƒê¸°ë¶€_ê²°ê³¼) -->
                                <input type="text" name="target_col_name" id="targetColInput" class="form-control" value="AI_ìƒê¸°ë¶€_ê²°ê³¼" placeholder="ìƒˆë¡œìš´ ì—´ ì´ë¦„ ì…ë ¥">
                            </div>
                            <div class="form-text small text-primary" id="targetColHelp">
                                * ìƒˆë¡œìš´ ì—´ì„ ë§Œë“¤ê±°ë‚˜, ê¸°ì¡´ ì—´ì„ ì„ íƒí•´ ë‚´ìš©ì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        </div>

                        <!-- ì˜¨ë„ ì¡°ì ˆ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold d-flex justify-content-between">
                                <span>ì°½ì˜ì„± (0.1 ~ 1.0)</span>
                                <span id="tempValue" class="text-primary">0.7</span>
                            </label>
                            <input type="range" name="temperature" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7" oninput="document.getElementById('tempValue').innerText = this.value">
                        </div>

                        <!-- â˜… 1. í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (3ë‹¨ ì½¤ë³´) -->
                        <div class="p-3 bg-light rounded border mb-3">
                            <label class="form-label fw-bold text-primary"><i class="bi bi-magic"></i> í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì„ íƒ</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select class="form-select" id="mainCat" onchange="changeMainCat()">
                                        <option value="">1. ëŒ€ë¶„ë¥˜ ì„ íƒ</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="subCat" onchange="changeSubCat()" disabled>
                                        <option value="">2. ì†Œë¶„ë¥˜ ì„ íƒ</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="templateSelect" onchange="applyTemplate()" disabled>
                                        <option value="">3. í…œí”Œë¦¿ ì„ íƒ</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- â˜… í…œí”Œë¦¿ ì„¤ëª…/ê°€ì´ë“œ (ì„ íƒ ì‹œ í‘œì‹œ) -->
                            <div id="templateDescBox" class="alert alert-info mt-2 mb-0 d-none small">
                                <i class="bi bi-info-circle-fill"></i> <span id="templateDescText"></span>
                            </div>
                        </div>

                        <!-- â˜… 2. ìƒì„¸ ë‚´ìš© ì…ë ¥ (ë„“ì–´ì§„ í…ìŠ¤íŠ¸ë°•ìŠ¤) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">í”„ë¡¬í”„íŠ¸ ë§¥ë½</label>
                            <textarea name="p_context" id="p_context" class="form-control" rows="5" placeholder="ì˜ˆ: ê³ ë“±í•™êµ 1í•™ë…„ í†µí•©ì‚¬íšŒ ìˆ˜ì—… ì‹œê°„ì„."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">AIì˜ ì—­í• </label>
                            <textarea name="p_role" id="p_role" class="form-control" rows="5" placeholder="ì˜ˆ: 20ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ êµì‚¬"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">AIê°€ í•  ì¼</label>
                            <textarea name="p_task" id="p_task" class="form-control" rows="20" placeholder="ì˜ˆ: ê¸°ì´ˆ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ ê°•ì ì„ ë¶„ì„í•˜ì—¬..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ì›í•˜ëŠ” ê²°ê³¼ê°’ ì˜ˆì‹œ</label>
                            <textarea name="p_example" id="p_example" class="form-control" rows="10" placeholder="ì˜ˆ: ~~í•œ í™œë™ì„ í†µí•´ ~~í•œ ì—­ëŸ‰ì„ ë³´ì—¬ì¤Œ."></textarea>
                        </div>
                        
                        <!-- â˜… 3. ë¶„ëŸ‰ ì„ íƒ (ê´€ë¦¬ì ì„¤ì • ì˜µì…˜) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">ì›í•˜ëŠ” ë¶„ëŸ‰</label>
                            <select name="p_length" id="p_length" class="form-select">
                                <option value="">-- ë¶„ëŸ‰ ì„ íƒ --</option>
                                {% for opt in length_options %}
                                    <option value="{{ opt.value }}">{{ opt.label }}</option>
                                {% endfor %}
                            </select>
                            <!-- ì§ì ‘ ì…ë ¥ì´ í•„ìš”í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í…ìŠ¤íŠ¸ë°•ìŠ¤ë„ ìˆ¨ê²¨ë‘˜ ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë‹¨ ì…€ë ‰íŠ¸ë¡œ í†µì¼ -->
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg mt-3 fw-bold">
                            <i class="bi bi-play-circle-fill"></i> ë¶„ì„ ì‹¤í–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ë°ì´í„° ì „ë‹¬ 3ë‹¨ ì½¤ë³´ ë° ìë™ ì±„ìš°ê¸° -->
<script>
    // 1. ì„œë²„ì—ì„œ ë°›ì€ íŠ¸ë¦¬ ë°ì´í„° (JSON)
    const treeData = JSON.parse('{{ tree_data_json|escapejs }}');
    
    // DOM ìš”ì†Œ
    const mainCat = document.getElementById('mainCat');
    const subCat = document.getElementById('subCat');
    const templateSelect = document.getElementById('templateSelect');
    const descBox = document.getElementById('templateDescBox');
    
    // ì´ˆê¸°í™”: ëŒ€ë¶„ë¥˜ ì±„ìš°ê¸°
    for (const id in treeData) {
        let opt = document.createElement('option');
        opt.value = id;
        opt.innerText = treeData[id].name;
        mainCat.appendChild(opt);
    }

    // ëŒ€ë¶„ë¥˜ ë³€ê²½ ì‹œ -> ì†Œë¶„ë¥˜ ê°±ì‹ 
    function changeMainCat() {
        const mainId = mainCat.value;
        subCat.innerHTML = '<option value="">2. ì†Œë¶„ë¥˜ ì„ íƒ</option>';
        templateSelect.innerHTML = '<option value="">3. í…œí”Œë¦¿ ì„ íƒ</option>';
        descBox.classList.add('d-none');
        
        if (mainId && treeData[mainId].children) {
            subCat.disabled = false;
            templateSelect.disabled = true;
            const children = treeData[mainId].children;
            for (const subId in children) {
                let opt = document.createElement('option');
                opt.value = subId;
                opt.innerText = children[subId].name;
                subCat.appendChild(opt);
            }
        } else {
            subCat.disabled = true;
            templateSelect.disabled = true;
        }
    }

    // ì†Œë¶„ë¥˜ ë³€ê²½ ì‹œ -> í…œí”Œë¦¿ ëª©ë¡ ê°±ì‹ 
    function changeSubCat() {
        const mainId = mainCat.value;
        const subId = subCat.value;
        templateSelect.innerHTML = '<option value="">3. í…œí”Œë¦¿ ì„ íƒ</option>';
        descBox.classList.add('d-none');

        if (mainId && subId) {
            templateSelect.disabled = false;
            const templates = treeData[mainId].children[subId].templates;
            templates.forEach(t => {
                let opt = document.createElement('option');
                opt.value = JSON.stringify(t); // í…œí”Œë¦¿ ê°ì²´ ì „ì²´ë¥¼ ê°’ìœ¼ë¡œ ë„£ìŒ
                opt.innerText = t.title;
                templateSelect.appendChild(opt);
            });
        } else {
            templateSelect.disabled = true;
        }
    }

    // ê²°ê³¼ ì—´ ì´ë¦„ ì„ íƒ ì‹œ -> ì…ë ¥ í•„ë“œ í† ê¸€
    function toggleTargetColInput() {
        const select = document.getElementById('targetColSelect');
        const input = document.getElementById('targetColInput');
        const help = document.getElementById('targetColHelp');

        if (select.value === 'new') {
            input.readOnly = false;
            input.value = "AI_ìƒê¸°ë¶€_ê²°ê³¼"; // ê¸°ë³¸ê°’ ë³µì›
            input.focus();
            help.innerText = "* ìƒˆë¡œìš´ ì—´ì´ ìƒì„±ë©ë‹ˆë‹¤.";
            help.className = "form-text small text-primary";
        } else {
            input.readOnly = true;
            input.value = select.value; // ì„ íƒí•œ ì—´ ì´ë¦„ìœ¼ë¡œ ê°’ ì„¤ì •
            help.innerText = "âš ï¸ ì£¼ì˜: ì„ íƒí•œ ì—´ì˜ ë‚´ìš©ì´ AI ê²°ê³¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.";
            help.className = "form-text small text-danger fw-bold";
        }
    }

    // í…œí”Œë¦¿ ì„ íƒ ì‹œ -> ë³¸ë¬¸ ì±„ìš°ê¸°
    function applyTemplate() {
        const val = templateSelect.value;
        if (val) {
            const t = JSON.parse(val);
            
            // ì„¤ëª…ì°½ í‘œì‹œ
            if (t.description) {
                document.getElementById('templateDescText').innerText = t.description;
                descBox.classList.remove('d-none');
            } else {
                descBox.classList.add('d-none');
            }

            // ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('p_context').value = t.context;
            document.getElementById('p_role').value = t.role;
            document.getElementById('p_task').value = t.task;
            document.getElementById('p_example').value = t.example;
            
            // ë¶„ëŸ‰ ì„ íƒ (í•´ë‹¹í•˜ëŠ” ê°’ì´ ì˜µì…˜ì— ìˆìœ¼ë©´ ì„ íƒë¨)
            const lenSelect = document.getElementById('p_length');
            lenSelect.value = t.length; 
        }
    }
    
    function showLoading() {
        // ì²´í¬ë°•ìŠ¤ ì„ íƒ í™•ì¸
        const checkboxes = document.querySelectorAll('input[name="selected_cols"]:checked');
        if (checkboxes.length === 0) {
            alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë°ì´í„°(ì¬ë£Œ)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
            event.preventDefault();
            return;
        }

        // ë¡œë”© í™”ë©´ í‘œì‹œ
        document.getElementById('loadingOverlay').classList.remove('d-none');

        // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ê°ì§€ ì‹œì‘
        checkDownloadCookie();
    }

    // ì¿ í‚¤ í™•ì¸ í•¨ìˆ˜
    function checkDownloadCookie() {
        const checkInterval = setInterval(function() {
            if (document.cookie.indexOf('download_complete=true') !== -1) {
                // 1. ì™„ë£Œ ì‹ í˜¸ ê°ì§€ë¨!
                clearInterval(checkInterval); // ê°ì‹œ ì¢…ë£Œ
                
                // 2. ë¡œë”© í™”ë©´ ë„ê¸°
                document.getElementById('loadingOverlay').classList.add('d-none');
                
                // 3. ì¿ í‚¤ ì‚­ì œ (ë‹¤ìŒ ë²ˆì„ ìœ„í•´)
                document.cookie = "download_complete=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                
                // 4. ì„±ê³µ ì•Œë¦¼
                alert("âœ… ë¶„ì„ ë° ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                
                // (ì„ íƒì‚¬í•­) 1ë‹¨ê³„ë¡œ ëŒì•„ê°€ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // window.location.href = "{% url 'ai_generator_step1' %}";
            }
        }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸
    }

    // â˜… [í•µì‹¬] ì´ì–´ë‹¬ë¦¬ê¸° ì²˜ë¦¬ ë¡œì§
    const totalRows = {{ total_rows  }}; // ì „ì²´ í•™ìƒ ìˆ˜(í–‰ì˜ ê°œìˆ˜)
    
    let aiResults = []; // ê²°ê³¼ ëª¨ìœ¼ëŠ” ë°°ì—´

    async function startBatchProcess(e) {
        e.preventDefault(); // í¼ ì œì¶œ ë§‰ê¸°

        // ìœ íš¨ì„± ê²€ì‚¬
        const checkboxes = document.querySelectorAll('input[name="selected_cols"]:checked');
        if (checkboxes.length === 0) {
            alert("ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return;
        }

        // UI ì¼œê¸°
        document.getElementById('loadingOverlay').classList.remove('d-none');
        
        // ì„¤ì •ê°’ ìˆ˜ì§‘
        const selected_cols = Array.from(checkboxes).map(cb => cb.value);
        const prompt_system = `
            [ë§¥ë½] ${document.getElementById('p_context').value}
            [ì—­í• ] ${document.getElementById('p_role').value}
            [í•  ì¼] ${document.getElementById('p_task').value}
            [ì˜ˆì‹œ] ${document.getElementById('p_example').value}
            [ë¶„ëŸ‰] ${document.getElementById('p_length').value}
        `;
        const temperature = document.querySelector('input[name="temperature"]').value;

        // 1. ì „ì²´ ë°ì´í„° ê°œìˆ˜ íŒŒì•…ì„ ìœ„í•œ ì²« í˜¸ì¶œ (í˜¹ì€ views.pyì—ì„œ ë„˜ê²¨ì¤€ ê°’ ì‚¬ìš©)
        const totalCount = {{ total_rows }}; 
        document.getElementById('totalCount').innerText = totalCount;

        // 2. í•œ ëª…ì”© ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ (Loop)
        for (let i = 0; i < totalCount; i++) {

            // 1000ms(1ì´ˆ) ~ 4000ms(4ì´ˆ) ì‚¬ì´ì˜ ëœë¤í•œ ì‹œê°„ì„ ê³„ì‚°
            const randomDelay = Math.floor(Math.random() * 3000) + 1000;
            
            // ì§„í–‰ ìƒí™©ì— "ì ì‹œ ëŒ€ê¸° ì¤‘..." í‘œì‹œ (ì„ íƒì‚¬í•­)
            // document.getElementById('loadingText').innerText = "íŠ¸ë˜í”½ ì¡°ì ˆ ì¤‘... (" + (randomDelay/1000).toFixed(1) + "ì´ˆ ëŒ€ê¸°)";
            
            // ê³„ì‚°ëœ ì‹œê°„ë§Œí¼ ë©ˆì·„ë‹¤ê°€ ë‹¤ìŒ ì¤„ ì‹¤í–‰
            await new Promise(resolve => setTimeout(resolve, randomDelay));

            document.getElementById('currentCount').innerText = i + 1;
            updateProgress(i + 1, totalCount);

            try {
                const response = await fetch('/accounts/api/process-row/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        index: i,
                        selected_cols: selected_cols,
                        prompt_system: prompt_system,
                        temperature: temperature
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success' || data.status === 'skip') {
                    aiResults.push(data.result);
                } else {
                    console.error("Error:", data.message);
                    aiResults.push("[ì—ëŸ¬ ë°œìƒ]"); // ì¹¸ì„ ë¹„ìš°ì§€ ì•Šê³  ì—ëŸ¬ í‘œì‹œ
                }

            } catch (error) {
                console.error("Network Error:", error);
                aiResults.push("[ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜]");
            }
        }

        // 3. ì²˜ë¦¬ê°€ ë‹¤ ëë‚˜ë©´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­
        downloadFinalExcel();
    }

    function updateProgress(current, total) {
        const percent = Math.round((current / total) * 100);
        const bar = document.getElementById('progressBar');
        bar.style.width = percent + '%';
        bar.innerText = percent + '%';
    }

    function downloadFinalExcel() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/accounts/api/download-excel/';
        
        const inputResults = document.createElement('input');
        inputResults.type = 'hidden';
        inputResults.name = 'results';
        inputResults.value = JSON.stringify(aiResults);
        
        const inputColName = document.createElement('input');
        inputColName.type = 'hidden';
        inputColName.name = 'target_col_name';
        inputColName.value = document.getElementsByName('target_col_name')[0].value;

        form.appendChild(inputResults);
        form.appendChild(inputColName);
        document.body.appendChild(form);
        
        form.submit(); // ë‹¤ìš´ë¡œë“œ ì‹œì‘
        
        // ë§ˆë¬´ë¦¬
        alert("âœ… ëª¨ë“  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.");
        document.getElementById('loadingOverlay').classList.add('d-none');
    }
</script>
{% endblock %}