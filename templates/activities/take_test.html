{% extends 'base.html' %}

{% block content %}
<!-- UI 강제 조정 (메뉴 숨김, 여백 제거) -->
<style>
    /* 상단 네비게이션바 숨기기 */
    nav.navbar { display: none !important; }
    
    /* 전체 컨테이너 여백 제거 및 높이 확보 */
    body { padding-top: 0 !important; background-color: #f8f9fa; }
    .container-fluid { margin-top: 0 !important; padding: 10px; height: 100vh; }
    
    /* 카드 높이 꽉 채우기 */
    .full-height-card { height: 95vh; }
</style>
<!-- 1. 시험 시작 전 가림막 (전체 화면 유도용) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <h1 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square"></i> 평가 준비</h1>
        <div class="alert alert-warning text-start d-inline-block p-4 shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-3">⚠️ 응시 주의사항</h5>
            <ul class="mb-0">
                <li><strong>전체 화면</strong>으로 시험이 진행됩니다.</li>
                <li><strong>복사, 붙여넣기, 마우스 우클릭</strong>이 금지됩니다.</li>
                <li>화면을 벗어나거나 다른 창을 띄우면(Alt+Tab) <strong>부정행위로 간주</strong>될 수 있습니다.</li>
                <li>작성 중 <strong>임시 저장</strong>은 되지 않으니 주의하세요.</li>
            </ul>
        </div>
        <br>
        <button class="btn btn-primary btn-lg px-5 py-3 mt-4 fw-bold shadow" onclick="startTest()">
            네, 확인했습니다. 시험 시작하기
        </button>
    </div>
</div>

<!-- 화면 전체를 꽉 채우기 위해 container-fluid 및 높이 설정 -->
<div class="container-fluid vh-100 p-0 overflow-hidden" style="margin-top: -25px;">
    <div class="row h-100 g-0">
        
        <!-- [좌측 영역: 문제지] -->
        <div class="col-md-3 h-100 border-end bg-light shadow-sm overflow-auto p-3">
            <div class="card border-0 bg-transparent">
                <div class="card-header bg-dark text-white py-2 mb-3 rounded">
                    <h6 class="mb-0 small"><i class="bi bi-file-earmark-text me-2"></i> 문제지</h6>
                </div>
                
                <!-- 1. 과목/영역/활동명 -->
                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">
                        {% if activity.category == 'CREATIVE' %}활동명{% else %}과목 / 영역{% endif %}
                    </label>
                    <div class="p-2 bg-white border rounded small shadow-sm">
                        {% if activity.category == 'CREATIVE' %}
                            {{ activity.section }}
                        {% else %}
                            {{ activity.subject_name }} / {{ activity.section }}
                        {% endif %}
                    </div>
                </div>

                <!-- 2. 평가 주제 -->
                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">평가 주제</label>
                    <div class="p-2 border rounded fw-bold text-primary small bg-white shadow-sm">
                        {{ activity.title }}
                    </div>
                </div>

                <!-- 3. 평가 문항 (구조별 분기 처리) -->
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-question-circle-fill me-1"></i> 평가 문항</label>
                    <div class="p-3 border rounded bg-white shadow-sm small">
                        {% if activity.category == 'CREATIVE' %}
                            {{ activity.question|linebreaks }}
                        {% else %}
                            <!-- 교과 논술형의 경우 연결된 첫 번째 문항을 가져옴 -->
                            {{ activity.questions.first.content|linebreaks|default:"문항 내용이 없습니다." }}
                        {% endif %}
                    </div>
                </div>

                <!-- 4. 참고 자료 -->
                {% if activity.reference_material or activity.attachment or activity.questions.first.reference_material %}
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-info-circle-fill me-1"></i> 참고 자료</label>
                    <div class="p-3 border rounded bg-white shadow-sm small">
                        {% if activity.category == 'CREATIVE' %}
                            {{ activity.reference_material|linebreaks }}
                        {% else %}
                            {{ activity.questions.first.reference_material|linebreaks|default:"참고 자료가 없습니다." }}
                        {% endif %}
                        
                        {% if activity.attachment %}
                        <div class="mt-3">
                            <a href="{{ activity.attachment.url }}" class="btn btn-sm btn-outline-dark w-100" target="_blank">
                                <i class="bi bi-download"></i> 첨부파일 보기
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 5. 작성 조건 -->
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-exclamation-circle-fill me-1"></i> 작성 조건</label>
                    <div class="p-3 border rounded small shadow-sm" style="background-color: #fff9e6;">
                        {% if activity.category == 'CREATIVE' %}
                            {{ activity.conditions|linebreaks|default:"특별한 조건이 없습니다." }}
                        {% else %}
                            {{ activity.questions.first.conditions|linebreaks|default:"특별한 조건이 없습니다." }}
                        {% endif %}
                        
                        {% if activity.char_limit > 0 %}
                        <div class="mt-2 fw-bold text-danger">(분량 제한: {{ activity.char_limit }}자 이상)</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- [우측 영역: 답안지] -->
        <div class="col-md-9 h-100 d-flex flex-column bg-white">
            <div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center shadow-sm">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-pencil-square me-2"></i> 답안 작성 ({{ user.name }})
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="charCount" class="badge bg-white text-primary px-3 py-2">0자 / {{ activity.char_limit|default:0 }}자 이상</span>
                    <button type="button" class="btn btn-outline-light btn-sm px-3" onclick="location.href='{% url 'dashboard' %}'">나가기</button>
                    <button type="button" class="btn btn-danger btn-sm px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#submitModal">답안제출</button>
                </div>
            </div>

            <div class="flex-grow-1 p-4">
                <textarea id="id_content" name="content" class="form-control border-0 h-100 shadow-none" 
                          style="resize: none; font-size: 1.1rem;" placeholder="여기에 답안을 작성하세요."></textarea>
            </div>
        </div>
    </div>
</div>

<!-- 시작 가림막 (전체화면 유도) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark d-flex flex-column justify-content-center align-items-center" style="z-index: 9999; --bs-bg-opacity: .95;">
    <div class="text-white text-center mb-4">
        <h2 class="fw-bold mb-3">평가 응시 준비</h2>
        <p>평가 보안을 위해 전체 화면 모드로 전환됩니다.</p>
    </div>
    <button class="btn btn-primary btn-lg px-5 py-3 fw-bold" onclick="startTest()">응시 시작하기</button>
</div>

<!-- 3. 제출 확인 모달 (중앙 정렬) -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill"></i> 답안 제출 확인</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <h4 class="fw-bold mb-3">정말 제출하시겠습니까?</h4>
        <p class="text-muted mb-0">
            제출 후에는 <strong class="text-danger">수정이 불가능</strong>합니다.<br>
            작성한 내용을 다시 한번 확인해주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">아니오, 더 쓸래요</button>
        <button type="button" class="btn btn-danger px-4 fw-bold" onclick="document.getElementById('answerForm').submit()">네, 제출합니다</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 통합 보안 및 응시 기능 스크립트 -->
<script>
    /**
     * 1. 초기 설정 및 환경 변수
     */
    const EXAM_MODE = "{{ activity.exam_mode }}"; // 'OPEN' 또는 'CLOSED'
    const textarea = document.getElementById('id_content');
    const counter = document.getElementById('charCount');
    const charLimit = {{ activity.char_limit|default:0 }}; 
    const answerId = "{{ answer_id|default:'' }}"; 
    
    let isSubmitting = false; // 제출/나가기 중 감시 중단 플래그
    let testStarted = false;  // [신규] '응시 시작' 버튼을 눌렀는지 여부

    /**
     * 2. 공통 기능: 뒤로가기 방지 (History Trap)
     * 어떤 모드에서든 작성 중인 데이터 유실을 막기 위해 유지합니다.
     */
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
        alert("평가 중에는 뒤로 갈 수 없습니다. 제출 또는 나가기 버튼을 이용해주세요.");
    };

    /**
     * 3. 공통 기능: 실시간 글자 수 세기 (디자인 반영)
     */
    if (textarea && counter) {
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            if (charLimit > 0) {
                // "n자 이상" 목표 도달 여부에 따른 디자인 변경
                counter.innerText = `${currentLength}자 / 최소 ${charLimit}자`;
                counter.className = currentLength >= charLimit ? 'badge bg-success px-3 py-2' : 'badge bg-light text-primary px-3 py-2';
            } else {
                counter.innerText = `${currentLength}자`;
            }
        });
    }

    /**
     * 4. 응시 시작 로직 (가림막 제거 및 전체화면 요청)
     */
    function startTest() {
        const elem = document.documentElement;
        
        if (EXAM_MODE === 'CLOSED') {
            // [폐쇄형] 전체 화면 요청 후 시작
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => completeStart()).catch(err => {
                    alert("전체 화면 모드를 허용해야 시험을 볼 수 있습니다.");
                });
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen(); completeStart();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen(); completeStart();
            }
        } else {
            // [개방형] 바로 시작
            completeStart();
        }
    }

    function completeStart() {
        testStarted = true; // 이제부터 모든 보안 감시 가동
        document.getElementById('startOverlay').classList.add('d-none');
        // 문제지가 흐릿하게 보였다면 해제 (있을 경우)
        const testContainer = document.getElementById('testContainer');
        if(testContainer) testContainer.style.filter = "none";
    }

    /**
     * 5. [폐쇄형 전용] 보안 및 모니터링 상세 로직
     */
    if (EXAM_MODE === 'CLOSED') {
        
        // --- (1) 전체 화면 상태 실시간 감지 ---
        const handleFullscreenChange = () => {
            if (!testStarted || isSubmitting) return; 

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // 전체 화면이 풀렸을 때만 가림막을 다시 내리고 경고합니다.
                document.getElementById('startOverlay').classList.remove('d-none');
                const btn = document.querySelector('#startOverlay button');
                if(btn) {
                    btn.innerText = "⚠️ 보안 위험: 전체 화면으로 복귀하세요";
                    btn.classList.replace('btn-primary', 'btn-danger');
                }
                // 화면 블러 처리 (선택 사항)
                const testContainer = document.getElementById('testContainer');
                if(testContainer) testContainer.style.filter = "blur(15px)";
            }
        };

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // --- (2) 부정행위 방지 (키보드 및 마우스 제한) ---
        document.addEventListener('keydown', function(e) {
            if (!testStarted) return;

            // F11(전체화면 해제) 및 단축키 차단
            if (e.key === 'F11') {
                e.preventDefault();
                alert("보안상 전체화면을 해제할 수 없습니다.");
            }
            if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                alert("폐쇄형 모드에서는 복사/붙여넣기를 사용할 수 없습니다.");
            }
        });

        // 우클릭 차단
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- (3) 화면 이탈 감지 (Alt+Tab 등) 및 로그 전송 ---
        document.addEventListener("visibilitychange", () => {
            if (!testStarted || isSubmitting) return;

            if (document.hidden) {
                alert("⚠️ 경고: 화면을 이탈하지 마세요! 부정행위로 간주되어 로그에 기록됩니다.");
                sendLog('OUT');
            } else {
                sendLog('IN');
            }
        });

    } else {
        // [개방형] 자유로운 환경 안내
        console.log("개방형 응시 모드: 참고자료 확인 및 화면 전환이 허용됩니다.");
    }

    /**
     * 6. 서버 로그 전송 함수 (AJAX)
     */
    function sendLog(type) {
        if (!answerId) return; 

        fetch('/activities/api/log/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'answer_id': answerId,
                'type': type
            })
        }).then(res => console.log("Security Log Sent: " + type));
    }

    /**
     * 7. 상태 제어: 제출/나가기 시 감시 일시 해제
     */
    // (1) 제출 버튼 클릭 및 모달 제어
    const submitBtn = document.querySelector('[data-bs-target="#submitModal"]');
    if(submitBtn) {
        submitBtn.addEventListener('click', () => isSubmitting = true);
    }

    const submitModal = document.getElementById('submitModal');
    if(submitModal) {
        // 모달을 닫으면 다시 감시 시작 (실수로 눌렀을 경우 대비)
        submitModal.addEventListener('hidden.bs.modal', () => isSubmitting = false);
    }

    // (2) 나가기 버튼 클릭 시
    const exitBtn = document.getElementById('exitBtn');
    if (exitBtn) {
        exitBtn.addEventListener('click', () => isSubmitting = true);
    }
</script>

<style>
    /* 답안지 텍스트 영역 꽉 채우기 */
    #id_content {
        height: 100% !important;
        resize: none;
        font-size: 1.3rem; /* 글씨 입력도 시원하게 키움 */
        line-height: 1.8;
        padding: 30px;     /* 안쪽 여백 넉넉하게 */
        border: none;      /* 테두리 없애서 깔끔하게 */
        outline: none;     /* 클릭 시 파란 테두리 제거 */
        border-radius: 0 0 5px 5px; /* 하단 둥근 모서리 */
    }
</style>
{% endblock %}