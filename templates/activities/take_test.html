{% extends 'base.html' %}

{% block content %}
<!-- UI 강제 조정 (메뉴 숨김, 여백 제거) -->
<style>
    /* 상단 네비게이션바 숨기기 */
    nav.navbar { display: none !important; }
    
    /* 전체 컨테이너 여백 제거 및 높이 확보 */
    body { padding-top: 0 !important; background-color: #f8f9fa; }
    .container-fluid { margin-top: 0 !important; padding: 10px; height: 100vh; }
    
    /* 카드 높이 꽉 채우기 */
    .full-height-card { height: 95vh; }
</style>
<!-- 1. 시험 시작 전 가림막 (전체 화면 유도용) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <h1 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square"></i> 평가 준비</h1>
        <div class="alert alert-warning text-start d-inline-block p-4 shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-3">⚠️ 응시 주의사항</h5>
            <ul class="mb-0">
                <li><strong>전체 화면</strong>으로 시험이 진행됩니다.</li>
                <li><strong>복사, 붙여넣기, 마우스 우클릭</strong>이 금지됩니다.</li>
                <li>화면을 벗어나거나 다른 창을 띄우면(Alt+Tab) <strong>부정행위로 간주</strong>될 수 있습니다.</li>
                <li>작성 중 <strong>임시 저장</strong>은 되지 않으니 주의하세요.</li>
            </ul>
        </div>
        <br>
        <button class="btn btn-primary btn-lg px-5 py-3 mt-4 fw-bold shadow" onclick="startTest()">
            네, 확인했습니다. 시험 시작하기
        </button>
    </div>
</div>

<div class="container-fluid" id="testContainer" style="filter: blur(5px);"> 
    <div class="row h-100 g-2">
        <!-- 왼쪽: 문제지 (30%) -->
        <div class="card shadow-sm border-0 h-100 overflow-auto">
            <div class="card-header bg-secondary text-white py-2">
                <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i> 문제지</h6>
            </div>
            <div class="card-body p-3">
                
                <!-- 1. 과목/영역 (ESSAY) vs 활동명 (CREATIVE) -->
                <div class="mb-3">
                    <label class="small text-muted mb-1">
                        {% if activity.category == 'CREATIVE' %}활동명{% else %}과목 / 영역{% endif %}
                    </label>
                    <div class="p-2 bg-light border rounded small">
                        {% if activity.category == 'CREATIVE' %}
                            {{ activity.section }}
                        {% else %}
                            {{ activity.subject_name }} / {{ activity.section }}
                        {% endif %}
                    </div>
                </div>

                <!-- 2. 평가 주제 (공통) -->
                <div class="mb-3">
                    <label class="small text-muted mb-1">평가 주제</label>
                    <div class="p-2 border rounded fw-bold text-primary small" style="background-color: #fdfdfd;">
                        {{ activity.title }}
                    </div>
                </div>

                <!-- 3. 평가 문항 (공통) -->
                <div class="mb-3 border-top pt-3">
                    <label class="small text-muted mb-1"><i class="bi bi-question-circle-fill me-1"></i> 평가 문항</label>
                    <div class="p-3 border rounded bg-white shadow-sm small">
                        {{ activity.question|linebreaks }}
                    </div>
                </div>

                <!-- 4. 참고 자료 (자율활동은 문항 바로 아래 배치) -->
                {% if activity.reference_material or activity.attachment %}
                <div class="mb-3">
                    <label class="small text-muted mb-1"><i class="bi bi-info-circle-fill me-1"></i> 참고 자료</label>
                    <div class="p-2 border rounded bg-light small overflow-auto" style="max-height: 200px;">
                        {{ activity.reference_material|linebreaks|default:"설명이 없습니다." }}
                        
                        {% if activity.attachment %}
                        <div class="mt-2 border-top pt-2">
                            <a href="{{ activity.attachment.url }}" class="btn btn-sm btn-outline-dark w-100" target="_blank">
                                <i class="bi bi-download"></i> 첨부파일 보기/다운로드
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 5. 작성 조건 (공통) -->
                <div class="mb-3 border-top pt-3">
                    <label class="small text-muted mb-1"><i class="bi bi-exclamation-circle-fill me-1"></i> 작성 조건</label>
                    <div class="p-2 border rounded small" style="background-color: #fff9e6;">
                        {{ activity.conditions|linebreaks|default:"특별한 조건이 없습니다." }}
                    </div>
                </div>

                <!-- 6. 자율활동 전용 추가 정보 (작성분량, 제출기한) -->
                {% if activity.category == 'CREATIVE' %}
                <div class="mt-3 p-2 border-top">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">작성 분량</span>
                        <span class="small fw-bold text-danger">{{ activity.char_limit|default:0 }}자 이상</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="small text-muted">제출 기한</span>
                        <span class="small fw-bold">{{ activity.deadline|date:"Y-m-d H:i"|default:"무제한" }}</span>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- ★ 오른쪽: 답안지 (70%) -->
        <div class="col-lg-8 h-100">
            <div class="card shadow border-primary full-height-card">
                <div class="card-header bg-primary text-white py-4"> 
                    <div class="d-flex justify-content-between align-items-center">
                        
                        <!-- 왼쪽: 제목 + 글자 수 카운터 -->
                        <div class="d-flex align-items-center">
                            <!-- 글씨 크기 키움 (fs-3) -->
                            <span class="fs-3 fw-bold me-3">
                                <i class="bi bi-pencil-square"></i> 답안 작성 ({{ user.name }})
                            </span>
                            <!-- 글자 수 뱃지 이동 및 디자인 변경 -->
                            <span id="charCount" class="badge bg-white text-primary fs-6 border border-white">
                                0자 / {{ question.max_length|default:'무제한' }}
                            </span>
                        </div>

                        <!-- 오른쪽: 나가기 / 제출 버튼 -->
                        <div>
                            <!-- 나가기 버튼 (대시보드로 이동) -->
                            <!-- onclick에 confirm을 넣어서 실수로 나가는 것 방지 -->
                            <a href="{% url 'dashboard' %}" id="exitBtn" class="btn btn-outline-light btn-lg fw-bold me-2" onclick="return confirm('시험을 종료하고 나가시겠습니까?\n작성 중인 내용은 저장되지 않습니다.');">
                                <i class="bi bi-box-arrow-left"></i> 나가기
                            </a>
                            
                            <!-- 제출 버튼 (기존 기능 유지, 위치만 이동) -->
                            <!-- 빨간색 강조 (btn-danger), 테두리 추가 -->
                            <button type="button" class="btn btn-danger btn-lg fw-bold border border-white" data-bs-toggle="modal" data-bs-target="#submitModal">
                                <i class="bi bi-send-fill"></i> 답안제출
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body d-flex flex-column p-0">
                    <!-- 답안 제출 폼 -->
                    <form method="post" id="answerForm" class="h-100 d-flex flex-column">
                        {% csrf_token %}
                        <input type="hidden" id="answerId" value="{{ form.instance.id }}"> 

                        <!-- 답안 입력창 (높이 100% 꽉 채우기) -->
                        <div class="flex-grow-1">
                            <!-- style 수정: 테두리 없애고(border-0), 꽉 채움 -->
                            {{ form.content }}
                        </div>
                        
                        <!-- [삭제됨] 하단에 있던 커다란 제출 버튼 삭제 -->
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. 제출 확인 모달 (중앙 정렬) -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill"></i> 답안 제출 확인</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <h4 class="fw-bold mb-3">정말 제출하시겠습니까?</h4>
        <p class="text-muted mb-0">
            제출 후에는 <strong class="text-danger">수정이 불가능</strong>합니다.<br>
            작성한 내용을 다시 한번 확인해주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">아니오, 더 쓸래요</button>
        <button type="button" class="btn btn-danger px-4 fw-bold" onclick="document.getElementById('answerForm').submit()">네, 제출합니다</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 보안 및 기능 스크립트 -->
<script>
    /**
     * 1. 초기 설정 및 환경 변수
     */
    const EXAM_MODE = "{{ activity.exam_mode }}"; // 'OPEN' 또는 'CLOSED'
    const textarea = document.getElementById('id_content');
    const counter = document.getElementById('charCount');
    const charLimit = {{ activity.char_limit|default:0 }}; // "자 이상" 기준값
    const answerId = "{{ answer_id|default:'' }}"; 
    
    let isSubmitting = false; // 제출 중에는 감시 로직 중단용

    /**
     * 2. 공통 기능: 뒤로가기 방지 (Data Loss 방지)
     * 모드에 상관없이 작성 중인 데이터 보호를 위해 유지합니다.
     */
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
        alert("평가 중에는 브라우저 뒤로가기를 사용할 수 없습니다. 하단 버튼을 이용해주세요.");
    };

    /**
     * 3. 공통 기능: 실시간 글자 수 세기 (디자인 반영)
     */
    if (textarea && counter) {
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            if (charLimit > 0) {
                // "자 이상" 로직: 목표 도달 시 초록색, 미달 시 파란색/빨간색
                counter.innerText = `${currentLength}자 / 최소 ${charLimit}자`;
                counter.className = currentLength >= charLimit ? 'badge bg-success' : 'badge bg-light text-primary';
            } else {
                counter.innerText = `${currentLength}자`;
            }
        });
    }

    /**
     * 4. [폐쇄형 모드 전용] 보안 및 모니터링 로직
     */
    if (EXAM_MODE === 'CLOSED') {
        // --- (1) 전체 화면 강제 로직 ---
        function startTest() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => showContent()).catch(() => alert("전체 화면이 필요합니다."));
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(); showContent();
            }
        }

        function showContent() {
            document.getElementById('startOverlay').classList.add('d-none');
            document.getElementById('testContainer').style.filter = "none";
        }

        // 전체 화면 이탈 감지
        const handleFullscreenChange = () => {
            if (isSubmitting) return;
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // 이탈 시 가림막 활성화
                document.getElementById('testContainer').style.filter = "blur(15px)";
                document.getElementById('startOverlay').classList.remove('d-none');
                const btn = document.querySelector('#startOverlay button');
                if(btn) {
                    btn.innerText = "⚠️ 보안 위험: 전체 화면으로 복귀하세요";
                    btn.classList.replace('btn-primary', 'btn-danger');
                }
            }
        };
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

        // --- (2) 키보드 및 마우스 제한 ---
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F11') e.preventDefault(); // 전체화면 해제 방지
            // Ctrl+A, C, V 차단
            if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                alert("폐쇄형 모드에서는 복사/붙여넣기를 사용할 수 없습니다.");
            }
        });
        document.addEventListener('contextmenu', e => e.preventDefault()); // 우클릭 금지

        // --- (3) 탭 이탈 감지 및 로그 전송 ---
        document.addEventListener("visibilitychange", () => {
            if (isSubmitting) return;
            if (document.hidden) {
                alert("⚠️ 경고: 화면 이탈이 감지되었습니다. 로그에 기록됩니다.");
                sendLog('OUT');
            } else {
                sendLog('IN');
            }
        });

    } else {
        /**
         * 5. [개방형 모드 전용] 자유로운 환경 로직
         */
        // 개방형은 시작 버튼 클릭 시 바로 가림막 제거 (전체화면 불필요)
        function startTest() {
            showContent();
        }
        function showContent() {
            document.getElementById('startOverlay').classList.add('d-none');
            document.getElementById('testContainer').style.filter = "none";
        }
        console.log("개방형 응시 모드 활성화: 자료 참고가 가능합니다.");
    }

    /**
     * 6. 서버 로그 전송 (AJAX)
     */
    function sendLog(type) {
        if (!answerId) return;
        fetch('/activities/api/log/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'answer_id': answerId, 'type': type })
        }).then(res => console.log("Security Log: " + type));
    }

    /**
     * 7. 상태 제어: 제출/종료 시 감시 해제
     */
    // 제출 모달이 뜰 때 감시 중단
    const submitModal = document.getElementById('submitModal');
    if(submitModal) {
        submitModal.addEventListener('show.bs.modal', () => isSubmitting = true);
        submitModal.addEventListener('hidden.bs.modal', () => isSubmitting = false);
    }
    
    // 나가기 버튼 클릭 시 감시 중단
    const exitBtn = document.getElementById('exitBtn');
    if(exitBtn) {
        exitBtn.addEventListener('click', () => isSubmitting = true);
    }
</script>

<style>
    /* 답안지 텍스트 영역 꽉 채우기 */
    #id_content {
        height: 100% !important;
        resize: none;
        font-size: 1.3rem; /* 글씨 입력도 시원하게 키움 */
        line-height: 1.8;
        padding: 30px;     /* 안쪽 여백 넉넉하게 */
        border: none;      /* 테두리 없애서 깔끔하게 */
        outline: none;     /* 클릭 시 파란 테두리 제거 */
        border-radius: 0 0 5px 5px; /* 하단 둥근 모서리 */
    }
</style>
{% endblock %}