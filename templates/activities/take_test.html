{% extends 'base.html' %}

{% block content %}
<!-- UI 강제 조정 (메뉴 숨김, 여백 제거) -->
<style>
    /* 상단 네비게이션바 숨기기 */
    nav.navbar { display: none !important; }
    
    /* 전체 컨테이너 여백 제거 및 높이 확보 */
    body { padding-top: 0 !important; background-color: #f8f9fa; }
    .container-fluid { margin-top: 0 !important; padding: 10px; height: 100vh; }
    
    /* 카드 높이 꽉 채우기 */
    .full-height-card { height: 95vh; }
</style>
<!-- 1. 시험 시작 전 가림막 (전체 화면 유도용) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <h1 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square"></i> 평가 준비</h1>
        <div class="alert alert-warning text-start d-inline-block p-4 shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-3">⚠️ 응시 주의사항</h5>
            <ul class="mb-0">
                <li><strong>전체 화면</strong>으로 시험이 진행됩니다.</li>
                <li><strong>복사, 붙여넣기, 마우스 우클릭</strong>이 금지됩니다.</li>
                <li>화면을 벗어나거나 다른 창을 띄우면(Alt+Tab) <strong>부정행위로 간주</strong>될 수 있습니다.</li>
                <li>작성 중 <strong>임시 저장</strong>은 되지 않으니 주의하세요.</li>
            </ul>
        </div>
        <br>
        <button class="btn btn-primary btn-lg px-5 py-3 mt-4 fw-bold shadow" onclick="startTest()">
            네, 확인했습니다. 시험 시작하기
        </button>
    </div>
</div>

<div class="container-fluid" id="testContainer" style="filter: blur(5px);"> 
    <div class="row h-100 g-2">
        <!-- 왼쪽: 문제지 (30%) -->
        <div class="col-lg-4 h-100">
            <div class="card shadow-sm border-secondary full-height-card" style="overflow-y: auto;">
                <div class="card-header bg-secondary text-white fw-bold sticky-top">
                    <i class="bi bi-file-text"></i> 문제지
                </div>
                <div class="card-body bg-light">
                    <!-- 문제 내용 표시 -->
                    <div class="mb-3">
                        <label class="fw-bold text-secondary small">과목 / 영역</label>
                        <div class="bg-white border rounded p-2 text-dark">
                            {{ activity.subject_name }} / {{ activity.section }}
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="fw-bold text-secondary small">평가 주제</label>
                        <div class="bg-white border rounded p-2 fw-bold text-primary">
                            {{ activity.title }}
                        </div>
                    </div>

                    <hr>

                    <!-- 문항 내용 -->
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-question-circle-fill"></i> 평가 문항</label>
                        <div class="p-3 bg-white border rounded text-break" style="white-space: pre-wrap;">{{ question.content }}</div>
                    </div>

                    <!-- 참고 자료 -->
                    {% if question.reference %}
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-journal-text"></i> 참고 자료</label>
                        <div class="p-3 bg-white border rounded text-muted small text-break" style="white-space: pre-wrap;">{{ question.reference }}</div>
                    </div>
                    {% endif %}

                    <!-- 작성 조건 -->
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-exclamation-circle"></i> 작성 조건</label>
                        <div class="alert alert-warning mb-0 small">
                            {{ question.conditions|default:"특별한 조건이 없습니다."|linebreaksbr }}
                            {% if question.max_length %}
                                <br><strong>(분량 제한: {{ question.max_length }}자 이내)</strong>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ★ 오른쪽: 답안지 (70%) -->
        <div class="col-lg-8 h-100">
            <div class="card shadow border-primary full-height-card">
                <div class="card-header bg-primary text-white py-4"> 
                    <div class="d-flex justify-content-between align-items-center">
                        
                        <!-- 왼쪽: 제목 + 글자 수 카운터 -->
                        <div class="d-flex align-items-center">
                            <!-- 글씨 크기 키움 (fs-3) -->
                            <span class="fs-3 fw-bold me-3">
                                <i class="bi bi-pencil-square"></i> 답안 작성 ({{ user.name }})
                            </span>
                            <!-- 글자 수 뱃지 이동 및 디자인 변경 -->
                            <span id="charCount" class="badge bg-white text-primary fs-6 border border-white">
                                0자 / {{ question.max_length|default:'무제한' }}
                            </span>
                        </div>

                        <!-- 오른쪽: 나가기 / 제출 버튼 -->
                        <div>
                            <!-- 나가기 버튼 (대시보드로 이동) -->
                            <!-- onclick에 confirm을 넣어서 실수로 나가는 것 방지 -->
                            <a href="{% url 'dashboard' %}" id="exitBtn" class="btn btn-outline-light btn-lg fw-bold me-2" onclick="return confirm('시험을 종료하고 나가시겠습니까?\n작성 중인 내용은 저장되지 않습니다.');">
                                <i class="bi bi-box-arrow-left"></i> 나가기
                            </a>
                            
                            <!-- 제출 버튼 (기존 기능 유지, 위치만 이동) -->
                            <!-- 빨간색 강조 (btn-danger), 테두리 추가 -->
                            <button type="button" class="btn btn-danger btn-lg fw-bold border border-white" data-bs-toggle="modal" data-bs-target="#submitModal">
                                <i class="bi bi-send-fill"></i> 답안제출
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body d-flex flex-column p-0">
                    <!-- 답안 제출 폼 -->
                    <form method="post" id="answerForm" class="h-100 d-flex flex-column">
                        {% csrf_token %}
                        <input type="hidden" id="answerId" value="{{ form.instance.id }}"> 

                        <!-- 답안 입력창 (높이 100% 꽉 채우기) -->
                        <div class="flex-grow-1">
                            <!-- style 수정: 테두리 없애고(border-0), 꽉 채움 -->
                            {{ form.content }}
                        </div>
                        
                        <!-- [삭제됨] 하단에 있던 커다란 제출 버튼 삭제 -->
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. 제출 확인 모달 (중앙 정렬) -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill"></i> 답안 제출 확인</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <h4 class="fw-bold mb-3">정말 제출하시겠습니까?</h4>
        <p class="text-muted mb-0">
            제출 후에는 <strong class="text-danger">수정이 불가능</strong>합니다.<br>
            작성한 내용을 다시 한번 확인해주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">아니오, 더 쓸래요</button>
        <button type="button" class="btn btn-danger px-4 fw-bold" onclick="document.getElementById('answerForm').submit()">네, 제출합니다</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 보안 및 기능 스크립트 -->
<script>
    const textarea = document.getElementById('id_content');
    const counter = document.getElementById('charCount');
    const limit = {{ question.max_length|default:0 }};
    
    // 제출 중인지 확인하는 상태 변수
    let isSubmitting = false;
    // 답안지 ID (DB에 이미 생성된 껍데기가 있어야 함. create_or_get 로직 필요)
    // * 주의: 처음에 답안지가 없는 상태라면 뷰에서 context로 answer.id를 넘겨줘야 함.
    // * views.py의 take_test 함수에서 existing_answer.id를 context에 넣어주세요.
    const answerId = "{{ form.instance.id|default:'' }}"; 

    // 1. 뒤로가기 감옥 (History Trap)
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
        alert("평가 중에는 뒤로 갈 수 없습니다. 제출 버튼을 이용해주세요.");
    };
    
    // 1. 글자 수 세기
    textarea.addEventListener('input', function() {
        const currentLength = this.value.length;
        if (limit > 0) {
            counter.innerText = `${currentLength}자 / ${limit}자`;
            counter.className = currentLength > limit ? 'badge bg-danger' : 'badge bg-light text-primary';
        } else {
            counter.innerText = `${currentLength}자`;
        }
    });

    // 2. 시험 시작 및 전체 화면 강제 함수
    function startTest() {
        const elem = document.documentElement;
        
        // 브라우저 호환성을 위한 전체화면 요청
        if (elem.requestFullscreen) {
            elem.requestFullscreen().then(() => {
                showContent();
            }).catch(err => {
                alert("전체 화면 모드를 허용해야 시험을 볼 수 있습니다.");
            });
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
            showContent();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
            showContent();
        }
    }

    // 화면 보여주기 함수
    function showContent() {
        document.getElementById('startOverlay').classList.add('d-none');
        document.getElementById('testContainer').style.filter = "none";
    }

    // ★ [핵심] 전체 화면 상태 감지 리스너
    // (ESC나 F11로 전체 화면이 풀리면 즉시 가림막을 내립니다)
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    function handleFullscreenChange() {
        // 제출 중이거나 나가기 버튼을 눌렀다면 감시하지 않음!
        if (isSubmitting) return; 

        if (!document.fullscreenElement && 
            !document.webkitFullscreenElement && 
            !document.mozFullScreenElement && 
            !document.msFullscreenElement) {
            
            // 전체 화면이 아님! -> 가림막 활성화
            document.getElementById('testContainer').style.filter = "blur(10px)";
            document.getElementById('startOverlay').classList.remove('d-none');
            
            // 버튼 텍스트 변경 (재진입 유도)
            const btn = document.querySelector('#startOverlay button');
            btn.innerText = "⚠️ 시험 계속하기 (전체 화면 복귀)";
            btn.classList.replace('btn-primary', 'btn-danger');
        } else {
            // 전체 화면 상태임 -> 내용 보이기
            showContent();
        }
    }

    // 3. 부정행위 방지 (키보드 막기)
    document.addEventListener('keydown', function(e) {
        // F11 (전체화면 해제 시도) 차단
        if (e.key === 'F11') {
            e.preventDefault();
            alert("보안상 전체화면을 해제할 수 없습니다.");
            return false;
        }
        // Ctrl+A, Ctrl+C, Ctrl+V 차단
        if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'A', 'C', 'V'].includes(e.key)) {
            e.preventDefault();
            // alert("보안상 단축키를 사용할 수 없습니다."); // (너무 자주 뜨면 귀찮으니 주석 처리 가능)
            return false;
        }
    });

    // 마우스 우클릭 차단
    document.addEventListener('contextmenu', event => event.preventDefault());

    // 4. 화면 이탈 감지 (Alt+Tab 등)
    document.addEventListener("visibilitychange", () => {
        // ★ 제출 버튼을 누른 상태(isSubmitting)라면 경고를 띄우지 않음!
        if (isSubmitting) return;

        if (document.hidden) {
            alert("⚠️ 경고: 화면을 이탈하지 마세요! 부정행위로 간주될 수 있습니다.");
            sendLog('OUT');
        } else {
            sendLog('IN');
        }
    });

    // 로그 전송 함수 (AJAX)
    function sendLog(type) {
        if (!answerId) return; // 답안지 ID가 없으면 기록 불가 (최초 진입 시)

        fetch('/activities/api/log/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'answer_id': answerId,
                'type': type
            })
        }).then(res => console.log("Log sent: " + type));
    }

    // 나가기 버튼 클릭 시 '감시 해제' 설정
    const exitBtn = document.getElementById('exitBtn');
    if (exitBtn) {
        exitBtn.addEventListener('click', function() {
            // 사용자가 confirm 창에서 '취소'를 누를 수도 있으니
            // confirm이 true일 때만 감시를 해제해야 하지만, 
            // href 링크의 onclick이 먼저 실행되므로, 
            // 여기서는 일단 클릭하면 isSubmitting을 true로 만들어서 블러를 막습니다.
            // (만약 취소하면 다시 false로 돌리는 복잡한 로직보다는, 
            //  순간적인 블러를 막는 게 목적이므로 true로 설정합니다.)
            isSubmitting = true; 
        });
    }

    // 5. 제출 버튼 클릭 시 '제출 중' 상태로 변경
    // (모달이 뜨는 버튼에 id="submitBtn"을 추가하거나, 아래처럼 선택자로 잡음)
    const submitBtn = document.querySelector('[data-bs-target="#submitModal"]');
    if(submitBtn) {
        submitBtn.addEventListener('click', function() {
            isSubmitting = true; // 이제부터 감시 중단
        });
    }

    // (만약 모달에서 '취소'를 누르면 다시 감시 시작)
    const submitModal = document.getElementById('submitModal');
    if(submitModal) {
        submitModal.addEventListener('hidden.bs.modal', function () {
            isSubmitting = false; // 다시 감시 시작
        });
    }
</script>

<style>
    /* 답안지 텍스트 영역 꽉 채우기 */
    #id_content {
        height: 100% !important;
        resize: none;
        font-size: 1.3rem; /* 글씨 입력도 시원하게 키움 */
        line-height: 1.8;
        padding: 30px;     /* 안쪽 여백 넉넉하게 */
        border: none;      /* 테두리 없애서 깔끔하게 */
        outline: none;     /* 클릭 시 파란 테두리 제거 */
        border-radius: 0 0 5px 5px; /* 하단 둥근 모서리 */
    }
</style>
{% endblock %}