{% extends 'base.html' %}

{% block content %}
<!-- UI 강제 조정 (메뉴 숨김, 여백 제거) -->
<style>
    /* 상단 네비게이션바 숨기기 */
    nav.navbar { display: none !important; }
    
    /* 전체 컨테이너 여백 제거 및 높이 확보 */
    body { padding-top: 0 !important; background-color: #f8f9fa; }
    .container-fluid { margin-top: 0 !important; padding: 10px; height: 100vh; }
    
    /* 카드 높이 꽉 채우기 */
    .full-height-card { height: 95vh; }
</style>
<!-- 1. 시험 시작 전 가림막 (전체 화면 유도용) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <h1 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square"></i> 평가 준비</h1>
        <div class="alert alert-warning text-start d-inline-block p-4 shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-3">⚠️ 응시 주의사항</h5>
            <ul class="mb-0">
                <li><strong>전체 화면</strong>으로 시험이 진행됩니다.</li>
                <li><strong>복사, 붙여넣기, 마우스 우클릭</strong>이 금지됩니다.</li>
                <li>화면을 벗어나거나 다른 창을 띄우면(Alt+Tab) <strong>부정행위로 간주</strong>될 수 있습니다.</li>
                <li>작성 중 <strong>임시 저장</strong>은 되지 않으니 주의하세요.</li>
            </ul>
        </div>
        <br>
        <button class="btn btn-primary btn-lg px-5 py-3 mt-4 fw-bold shadow" onclick="startTest()">
            네, 확인했습니다. 시험 시작하기
        </button>
    </div>
</div>

<!-- 화면 전체를 꽉 채우기 위해 container-fluid 및 높이 설정 -->
<div class="container-fluid vh-100 p-0 overflow-hidden" style="margin-top: -25px;">
    <div class="row h-100 g-0">
        
        <!-- [좌측 영역: 문제지 (비율 3)] -->
        <div class="col-md-3 h-100 border-end bg-light shadow-sm overflow-auto p-3" style="max-height: 100vh;">
            <div class="card border-0 bg-transparent">
                <div class="card-header bg-dark text-white py-2 mb-3 rounded">
                    <h6 class="mb-0 small"><i class="bi bi-file-earmark-text me-2"></i> 문제지</h6>
                </div>
                
                <!-- 활동명/과목 -->
                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">
                        {% if activity.category == 'CREATIVE' %}활동명{% else %}과목 / 영역{% endif %}
                    </label>
                    <div class="p-2 bg-white border rounded small shadow-sm">
                        {% if activity.category == 'CREATIVE' %}{{ activity.section }}{% else %}{{ activity.subject_name }} / {{ activity.section }}{% endif %}
                    </div>
                </div>

                <!-- 평가 주제 -->
                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">평가 주제</label>
                    <div class="p-2 border rounded fw-bold text-primary small bg-white shadow-sm">
                        {{ activity.title }}
                    </div>
                </div>

                <!-- 평가 문항 -->
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-question-circle-fill me-1"></i> 평가 문항</label>
                    <div class="p-3 border rounded bg-white shadow-sm small" style="line-height: 1.6;">
                        {{ activity.question|linebreaks }}
                    </div>
                </div>

                <!-- 참고 자료 (카테고리 구분 없이 데이터 있으면 출력) -->
                {% if activity.reference_material or activity.attachment %}
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-info-circle-fill me-1"></i> 참고 자료</label>
                    <div class="p-3 border rounded bg-white shadow-sm small">
                        {{ activity.reference_material|linebreaks|default:"내용 없음" }}
                        {% if activity.attachment %}
                        <div class="mt-3">
                            <a href="{{ activity.attachment.url }}" class="btn btn-sm btn-outline-dark w-100" target="_blank">
                                <i class="bi bi-download"></i> 첨부파일 보기/다운로드
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 작성 조건 -->
                <div class="mb-3 pt-2">
                    <label class="small text-muted fw-bold mb-1"><i class="bi bi-exclamation-circle-fill me-1"></i> 작성 조건</label>
                    <div class="p-3 border rounded small shadow-sm" style="background-color: #fff9e6; border-left: 4px solid #ffc107 !important;">
                        {{ activity.conditions|linebreaks|default:"특별한 조건이 없습니다." }}
                        {% if activity.char_limit > 0 %}
                        <div class="mt-2 fw-bold text-danger">(분량 제한: {{ activity.char_limit }}자 이상)</div>
                        {% endif %}
                    </div>
                </div>

                <!-- 자율활동 전용 요약 (하단 고정 느낌으로 추가) -->
                {% if activity.category == 'CREATIVE' %}
                <div class="mt-4 p-3 border rounded bg-white shadow-sm small">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">작성 분량</span>
                        <span class="fw-bold text-danger">{{ activity.char_limit|default:0 }}자 이상</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">제출 기한</span>
                        <span class="fw-bold">{{ activity.deadline|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
            <div style="height: 50px;"></div> <!-- 하단 여유 공간 -->
        </div>

        <!-- [우측 영역: 답안지 (비율 7)] -->
        <div class="col-md-9 h-100 d-flex flex-column bg-white">
            <!-- 답안지 헤더 -->
            <div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center shadow-sm">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-pencil-square me-2"></i> 답안 작성 ({{ user.name }})
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <!-- 글자수 표시 -->
                    <span id="charCount" class="badge bg-white text-primary px-3 py-2">0자 / {% if activity.char_limit %}{{ activity.char_limit }}자 이상{% else %}무제한{% endif %}</span>
                    <button type="button" class="btn btn-outline-light btn-sm px-3" id="exitBtn" onclick="location.href='{% url 'dashboard' %}'">
                        <i class="bi bi-box-arrow-right"></i> 나가기
                    </button>
                    <button type="button" class="btn btn-danger btn-sm px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#submitModal">
                        <i class="bi bi-send-fill"></i> 답안제출
                    </button>
                </div>
            </div>

            <!-- 답안 작성창 (높이 자동 꽉 채움) -->
            <div class="flex-grow-1 p-4">
                <textarea id="id_content" name="content" class="form-control border-0 h-100 shadow-none" 
                          style="resize: none; font-size: 1.1rem; outline: none;" 
                          placeholder="여기에 답안을 작성하세요."></textarea>
            </div>
        </div>
        
    </div>
</div>

<!-- 3. 제출 확인 모달 (중앙 정렬) -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill"></i> 답안 제출 확인</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <h4 class="fw-bold mb-3">정말 제출하시겠습니까?</h4>
        <p class="text-muted mb-0">
            제출 후에는 <strong class="text-danger">수정이 불가능</strong>합니다.<br>
            작성한 내용을 다시 한번 확인해주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">아니오, 더 쓸래요</button>
        <button type="button" class="btn btn-danger px-4 fw-bold" onclick="document.getElementById('answerForm').submit()">네, 제출합니다</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 보안 및 기능 스크립트 -->
<script>
    /**
     * 1. 초기 설정 및 환경 변수
     */
    const EXAM_MODE = "{{ activity.exam_mode }}"; // 'OPEN' 또는 'CLOSED'
    const textarea = document.getElementById('id_content');
    const counter = document.getElementById('charCount');
    const charLimit = {{ activity.char_limit|default:0 }}; // "자 이상" 기준값
    const answerId = "{{ answer_id|default:'' }}"; 
    
    let isSubmitting = false; // 제출 중에는 감시 로직 중단용

    /**
     * 2. 공통 기능: 뒤로가기 방지 (Data Loss 방지)
     * 모드에 상관없이 작성 중인 데이터 보호를 위해 유지합니다.
     */
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
        alert("평가 중에는 브라우저 뒤로가기를 사용할 수 없습니다. 하단 버튼을 이용해주세요.");
    };

    /**
     * 3. 공통 기능: 실시간 글자 수 세기 (디자인 반영)
     */
    if (textarea && counter) {
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            if (charLimit > 0) {
                // "자 이상" 로직: 목표 도달 시 초록색, 미달 시 파란색/빨간색
                counter.innerText = `${currentLength}자 / 최소 ${charLimit}자`;
                counter.className = currentLength >= charLimit ? 'badge bg-success' : 'badge bg-light text-primary';
            } else {
                counter.innerText = `${currentLength}자`;
            }
        });
    }

    /**
     * 4. [폐쇄형 모드 전용] 보안 및 모니터링 로직
     */
    if (EXAM_MODE === 'CLOSED') {
        // --- (1) 전체 화면 강제 로직 ---
        function startTest() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => showContent()).catch(() => alert("전체 화면이 필요합니다."));
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(); showContent();
            }
        }

        function showContent() {
            document.getElementById('startOverlay').classList.add('d-none');
            document.getElementById('testContainer').style.filter = "none";
        }

        // 전체 화면 이탈 감지
        const handleFullscreenChange = () => {
            if (isSubmitting) return;
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // 이탈 시 가림막 활성화
                document.getElementById('testContainer').style.filter = "blur(15px)";
                document.getElementById('startOverlay').classList.remove('d-none');
                const btn = document.querySelector('#startOverlay button');
                if(btn) {
                    btn.innerText = "⚠️ 보안 위험: 전체 화면으로 복귀하세요";
                    btn.classList.replace('btn-primary', 'btn-danger');
                }
            }
        };
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

        // --- (2) 키보드 및 마우스 제한 ---
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F11') e.preventDefault(); // 전체화면 해제 방지
            // Ctrl+A, C, V 차단
            if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                alert("폐쇄형 모드에서는 복사/붙여넣기를 사용할 수 없습니다.");
            }
        });
        document.addEventListener('contextmenu', e => e.preventDefault()); // 우클릭 금지

        // --- (3) 탭 이탈 감지 및 로그 전송 ---
        document.addEventListener("visibilitychange", () => {
            if (isSubmitting) return;
            if (document.hidden) {
                alert("⚠️ 경고: 화면 이탈이 감지되었습니다. 로그에 기록됩니다.");
                sendLog('OUT');
            } else {
                sendLog('IN');
            }
        });

    } else {
        /**
         * 5. [개방형 모드 전용] 자유로운 환경 로직
         */
        // 개방형은 시작 버튼 클릭 시 바로 가림막 제거 (전체화면 불필요)
        function startTest() {
            showContent();
        }
        function showContent() {
            document.getElementById('startOverlay').classList.add('d-none');
            document.getElementById('testContainer').style.filter = "none";
        }
        console.log("개방형 응시 모드 활성화: 자료 참고가 가능합니다.");
    }

    /**
     * 6. 서버 로그 전송 (AJAX)
     */
    function sendLog(type) {
        if (!answerId) return;
        fetch('/activities/api/log/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'answer_id': answerId, 'type': type })
        }).then(res => console.log("Security Log: " + type));
    }

    /**
     * 7. 상태 제어: 제출/종료 시 감시 해제
     */
    // 제출 모달이 뜰 때 감시 중단
    const submitModal = document.getElementById('submitModal');
    if(submitModal) {
        submitModal.addEventListener('show.bs.modal', () => isSubmitting = true);
        submitModal.addEventListener('hidden.bs.modal', () => isSubmitting = false);
    }
    
    // 나가기 버튼 클릭 시 감시 중단
    const exitBtn = document.getElementById('exitBtn');
    if(exitBtn) {
        exitBtn.addEventListener('click', () => isSubmitting = true);
    }
</script>

<style>
    /* 답안지 텍스트 영역 꽉 채우기 */
    #id_content {
        height: 100% !important;
        resize: none;
        font-size: 1.3rem; /* 글씨 입력도 시원하게 키움 */
        line-height: 1.8;
        padding: 30px;     /* 안쪽 여백 넉넉하게 */
        border: none;      /* 테두리 없애서 깔끔하게 */
        outline: none;     /* 클릭 시 파란 테두리 제거 */
        border-radius: 0 0 5px 5px; /* 하단 둥근 모서리 */
    }
</style>
{% endblock %}