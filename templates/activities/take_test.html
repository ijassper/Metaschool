{% extends 'base.html' %}

{% block content %}
<!-- 1. 시험 시작 전 가림막 (전체 화면 유도용) -->
<div id="startOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <h1 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square"></i> 평가 준비</h1>
        <div class="alert alert-warning text-start d-inline-block p-4 shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-3">⚠️ 응시 주의사항</h5>
            <ul class="mb-0">
                <li><strong>전체 화면</strong>으로 시험이 진행됩니다.</li>
                <li><strong>복사, 붙여넣기, 마우스 우클릭</strong>이 금지됩니다.</li>
                <li>화면을 벗어나거나 다른 창을 띄우면(Alt+Tab) <strong>부정행위로 간주</strong>될 수 있습니다.</li>
                <li>작성 중 <strong>임시 저장</strong>은 되지 않으니 주의하세요.</li>
            </ul>
        </div>
        <br>
        <button class="btn btn-primary btn-lg px-5 py-3 mt-4 fw-bold shadow" onclick="startTest()">
            네, 확인했습니다. 시험 시작하기
        </button>
    </div>
</div>

<div class="container-fluid mt-3 mb-5 px-4" id="testContainer" style="filter: blur(5px);"> 
    <div class="row h-100">
        <!-- ★ 왼쪽: 문제지 (30%) -->
        <div class="col-lg-4 mb-4 h-100">
            <div class="card shadow-sm border-secondary" style="height: 85vh; overflow-y: auto;">
                <div class="card-header bg-secondary text-white fw-bold sticky-top">
                    <i class="bi bi-file-text"></i> 문제지
                </div>
                <div class="card-body bg-light">
                    <!-- 기본 정보 -->
                    <div class="mb-3">
                        <label class="fw-bold text-secondary small">과목 / 영역</label>
                        <div class="bg-white border rounded p-2 text-dark">
                            {{ activity.subject_name }} / {{ activity.section }}
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="fw-bold text-secondary small">평가 주제</label>
                        <div class="bg-white border rounded p-2 fw-bold text-primary">
                            {{ activity.title }}
                        </div>
                    </div>

                    <hr>

                    <!-- 문항 내용 -->
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-question-circle-fill"></i> 평가 문항</label>
                        <div class="p-3 bg-white border rounded text-break" style="white-space: pre-wrap;">{{ question.content }}</div>
                    </div>

                    <!-- 참고 자료 -->
                    {% if question.reference %}
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-journal-text"></i> 참고 자료</label>
                        <div class="p-3 bg-white border rounded text-muted small text-break" style="white-space: pre-wrap;">{{ question.reference }}</div>
                    </div>
                    {% endif %}

                    <!-- 작성 조건 -->
                    <div class="mb-3">
                        <label class="fw-bold text-dark"><i class="bi bi-exclamation-circle"></i> 작성 조건</label>
                        <div class="alert alert-warning mb-0 small">
                            {{ question.conditions|default:"특별한 조건이 없습니다."|linebreaksbr }}
                            {% if question.max_length %}
                                <br><strong>(분량 제한: {{ question.max_length }}자 이내)</strong>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ★ 오른쪽: 답안지 (70%) -->
        <div class="col-lg-8 mb-4 h-100">
            <div class="card shadow border-primary" style="height: 85vh;">
                <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-pencil-square"></i> 답안 작성 ({{ user.name }})</span>
                    <span id="charCount" class="badge bg-light text-primary">0자 / {{ question.max_length|default:'무제한' }}</span>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- 답안 제출 폼 -->
                    <form method="post" id="answerForm" class="h-100 d-flex flex-column">
                        {% csrf_token %}
                        
                        <!-- 답안 입력창 (높이 꽉 채우기) -->
                        <div class="flex-grow-1 mb-3">
                            {{ form.content }}
                        </div>
                        
                        <!-- 제출 버튼 (빨간색) -->
                        <div class="d-grid">
                            <button type="button" class="btn btn-danger btn-lg fw-bold p-3" data-bs-toggle="modal" data-bs-target="#submitModal">
                                <i class="bi bi-send-fill"></i> 답안 제출하기
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. 제출 확인 모달 (중앙 정렬) -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill"></i> 답안 제출 확인</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <h4 class="fw-bold mb-3">정말 제출하시겠습니까?</h4>
        <p class="text-muted mb-0">
            제출 후에는 <strong class="text-danger">수정이 불가능</strong>합니다.<br>
            작성한 내용을 다시 한번 확인해주세요.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">아니오, 더 쓸래요</button>
        <button type="button" class="btn btn-danger px-4 fw-bold" onclick="document.getElementById('answerForm').submit()">네, 제출합니다</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 보안 및 기능 스크립트 -->
<script>
    const textarea = document.getElementById('id_content');
    const counter = document.getElementById('charCount');
    const limit = {{ question.max_length|default:0 }};
    
    // ★ [신규] 제출 중인지 확인하는 상태 변수
    let isSubmitting = false;

    // 1. 글자 수 세기
    textarea.addEventListener('input', function() {
        const currentLength = this.value.length;
        if (limit > 0) {
            counter.innerText = `${currentLength}자 / ${limit}자`;
            counter.className = currentLength > limit ? 'badge bg-danger' : 'badge bg-light text-primary';
        } else {
            counter.innerText = `${currentLength}자`;
        }
    });

    // 2. 시험 시작 (전체 화면 전환)
    function startTest() {
        document.getElementById('startOverlay').classList.add('d-none');
        document.getElementById('testContainer').style.filter = "none";
        
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(err => {
                console.log("전체화면 거부됨: " + err.message);
            });
        }
    }

    // 3. 부정행위 방지 (키보드 막기)
    document.addEventListener('keydown', function(e) {
        // F11 (전체화면 해제 시도) 차단
        if (e.key === 'F11') {
            e.preventDefault();
            alert("보안상 전체화면을 해제할 수 없습니다.");
            return false;
        }
        // Ctrl+A, Ctrl+C, Ctrl+V 차단
        if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'A', 'C', 'V'].includes(e.key)) {
            e.preventDefault();
            // alert("보안상 단축키를 사용할 수 없습니다."); // (너무 자주 뜨면 귀찮으니 주석 처리 가능)
            return false;
        }
    });

    // 마우스 우클릭 차단
    document.addEventListener('contextmenu', event => event.preventDefault());

    // 4. [핵심 수정] 화면 이탈 감지 (Alt+Tab 등)
    document.addEventListener("visibilitychange", () => {
        // ★ 제출 버튼을 누른 상태(isSubmitting)라면 경고를 띄우지 않음!
        if (isSubmitting) return;

        if (document.hidden) {
            alert("⚠️ 경고: 화면을 이탈하지 마세요! 부정행위로 간주될 수 있습니다.");
        }
    });

    // 5. [신규] 제출 버튼 클릭 시 '제출 중' 상태로 변경
    // (모달이 뜨는 버튼에 id="submitBtn"을 추가하거나, 아래처럼 선택자로 잡음)
    const submitBtn = document.querySelector('[data-bs-target="#submitModal"]');
    if(submitBtn) {
        submitBtn.addEventListener('click', function() {
            isSubmitting = true; // 이제부터 감시 중단
        });
    }

    // (만약 모달에서 '취소'를 누르면 다시 감시 시작)
    const submitModal = document.getElementById('submitModal');
    if(submitModal) {
        submitModal.addEventListener('hidden.bs.modal', function () {
            isSubmitting = false; // 다시 감시 시작
        });
    }
</script>

<style>
    /* 답안지 텍스트 영역 꽉 채우기 */
    #id_content {
        height: 100% !important;
        resize: none;
        font-size: 1.1rem;
        line-height: 1.6;
    }
</style>
{% endblock %}