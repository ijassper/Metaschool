{% extends 'base.html' %}

{% block content %}
<!-- â˜… [ë””ë²„ê¹…ìš©] ë°ì´í„° í™•ì¸ ë°•ìŠ¤ (ë‚˜ì¤‘ì— ì§€ìš°ì„¸ìš”) -->
<div class="alert alert-danger text-break">
    <h5 class="fw-bold">ğŸ”¥ ë°ì´í„° ë””ë²„ê¹… ğŸ”¥</h5>
    <p><strong>ë„˜ì–´ì˜¨ ë°ì´í„°(filter_tree):</strong> {{ filter_tree }}</p>
</div>
<div class="container mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-primary"><i class="bi bi-card-checklist"></i> ì œì¶œ í˜„í™©: {{ activity.title }}</h3>
        <a href="{% url 'activity_list' %}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <!-- ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ -->
    <div class="bg-light p-3 rounded mb-3 border">
        <form method="get" id="filterForm" class="row g-2 align-items-center">
            
            <!-- â˜… [ì‹ ê·œ] í•™ë…„/ë°˜ ë‹¤ì¤‘ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn btn-white border dropdown-toggle bg-white" type="button" id="classFilterBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                        <i class="bi bi-funnel-fill text-secondary"></i> í•™ê¸‰ ì„ íƒ
                    </button>
                    <div class="dropdown-menu p-3 shadow" style="min-width: 250px; max-height: 400px; overflow-y: auto;">
                        <h6 class="dropdown-header fw-bold mb-2">í•„í„°ë§í•  í•™ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</h6>
                        
                        <!-- íŠ¸ë¦¬ êµ¬ì¡° ì¶œë ¥ -->
                        {% for item in filter_data %} <!-- filter_tree.items ëŒ€ì‹  filter_data ì‚¬ìš© -->
                        <div class="mb-2">
                            <!-- í•™ë…„ (ë¶€ëª¨) -->
                            <div class="form-check fw-bold text-primary">
                                <input class="form-check-input parent-check" type="checkbox" id="g_{{ item.grade }}" onchange="toggleGrade('{{ item.grade }}')">
                                <label class="form-check-label" for="g_{{ item.grade }}">
                                    {{ item.grade }}í•™ë…„
                                </label>
                            </div>
                            
                            <!-- ë°˜ (ìì‹ ì²´í¬ë°•ìŠ¤ë“¤) - ë“¤ì—¬ì“°ê¸° -->
                            <div class="ms-3 border-start ps-2 mt-1">
                                {% for c in classes %}
                                    {% with g_str=item.grade|stringformat:"s" c_str=c|stringformat:"s" %}
                                    {% with target_val=g_str|add:"_"|add:c_str %} 
                                    <div class="form-check">
                                        <input class="form-check-input child-check child-g-{{ grade }}" 
                                               type="checkbox" 
                                               name="target" 
                                               value="{{ grade }}_{{ c }}" 
                                               id="c_{{ grade }}_{{ c }}"
                                               {% if target_val in selected_targets %}checked{% endif %}>
                                        <label class="form-check-label" for="c_{{ grade }}_{{ c }}">
                                            {{ c }}ë°˜
                                        </label>
                                    </div>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        <div class="d-grid mt-3 border-top pt-2">
                            <button type="submit" class="btn btn-primary btn-sm">ì ìš©í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í˜„ì¬ ì„ íƒëœ í•„í„° ìš”ì•½ í‘œì‹œ (ì„ íƒ ì‚¬í•­) -->
            <div class="col-auto">
                <span class="text-muted small">
                    {% if selected_targets %}
                        ì´ {{ selected_targets|length }}ê°œ í•™ê¸‰ ì„ íƒë¨
                    {% else %}
                        ì „ì²´ ë³´ê¸°
                    {% endif %}
                </span>
            </div>

            <!-- ì´ë¦„ ê²€ìƒ‰ -->
            <div class="col-auto ms-auto">
                <div class="input-group input-group-sm">
                    <input type="text" name="q" class="form-control" placeholder="ì´ë¦„ ê²€ìƒ‰" value="{{ current_q }}">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i></button>
                </div>
            </div>
            
            <!-- ì´ˆê¸°í™” -->
            <div class="col-auto">
                <a href="{% url 'activity_result' activity.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-counterclockwise"></i> ì´ˆê¸°í™”
                </a>
            </div>
        </form>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover text-center align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>í•™ë…„</th>
                        <th>ë°˜</th>
                        <th>ë²ˆí˜¸</th>
                        <th>ì´ë¦„</th>
                        <th>ìƒíƒœ</th>
                        <th>ì œì¶œ ì¼ì‹œ</th>
                        <th>ê²°ì‹œ ì‚¬ìœ </th>
                        <th>ë‹µì•ˆì§€</th>
                        <th>íŠ¹ì´ì‚¬í•­</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in submission_list %}
                    <tr>
                        <td>{{ item.student.grade }}</td>
                        <td>{{ item.student.class_no }}</td>
                        <td>{{ item.student.number }}</td>
                        <td class="fw-bold">{{ item.student.name }}</td>
                        
                        <!-- ìƒíƒœ -->
                        <td>
                            {% if item.status == 'ì œì¶œ ì™„ë£Œ' %}
                                <span class="badge bg-success">ì œì¶œ ì™„ë£Œ</span>
                            {% else %}
                                <span class="badge bg-secondary opacity-50">ë¯¸ì‘ì‹œ</span>
                            {% endif %}
                        </td>
                        
                        <!-- ì œì¶œ ì¼ì‹œ -->
                        <td class="small text-muted">
                            {% if item.answer_id %}{{ item.submitted_at|date:"m-d H:i" }}{% else %}-{% endif %}
                        </td>

                        <!-- ê²°ì‹œ ì‚¬ìœ  ì…€ë ‰íŠ¸ ë°•ìŠ¤ -->
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateAbsence('{{ item.student.id }}', '{{ activity.id }}', this.value)"
                                    style="width: 100px; margin: 0 auto;">
                                <option value="" {% if not item.absence %}selected{% endif %}>-</option>
                                <option value="ë³‘ê²°" {% if item.absence == 'ë³‘ê²°' %}selected{% endif %}>ë³‘ê²°</option>
                                <option value="ê³µê²°" {% if item.absence == 'ê³µê²°' %}selected{% endif %}>ê³µê²°</option>
                                <option value="ì¸ì •ê²°" {% if item.absence == 'ì¸ì •ê²°' %}selected{% endif %}>ì¸ì •ê²°</option>
                                <option value="ë¯¸ì¸ì •ê²°" {% if item.absence == 'ë¯¸ì¸ì •ê²°' %}selected{% endif %}>ë¯¸ì¸ì •ê²°</option>
                            </select>
                        </td>

                        <!-- ë‹µì•ˆì§€ ì—´ê¸° -->
                        <td>
                            {% if item.answer_id %}
                                <a href="{% url 'answer_detail' item.answer_id %}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="bi bi-search"></i> ì—´ê¸°
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- íŠ¹ì´ì‚¬í•­ (ë©”ëª¨) -->
                        <td>
                            {% if item.answer_id %}
                                <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#noteModal{{ item.answer_id }}">
                                    {% if item.note %}<i class="bi bi-sticky-fill"></i>{% else %}<i class="bi bi-sticky"></i>{% endif %}
                                </button>

                                <!-- ë©”ëª¨ ëª¨ë‹¬ (ê°œë³„ ìƒì„±) -->
                                <div class="modal fade" id="noteModal{{ item.answer_id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header bg-warning bg-opacity-25">
                                                <h5 class="modal-title fw-bold">íŠ¹ì´ì‚¬í•­ ë©”ëª¨</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form action="{% url 'save_note' item.answer_id %}" method="post">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <p class="text-start mb-2"><strong>{{ item.student.name }}</strong> í•™ìƒì— ëŒ€í•œ ë©”ëª¨:</p>
                                                    <textarea name="note" class="form-control" rows="5">{{ item.note }}</textarea>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- íê¸°(ì‚­ì œ) -->
                        <td>
                            {% if item.answer_id %}
                                <a href="{% url 'answer_delete' item.answer_id %}" 
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('ì´ í•™ìƒì˜ ë‹µì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ í•™ìƒì€ ë‹¤ì‹œ ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');">
                                   íê¸°
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // í•™ë…„ ì²´í¬ë°•ìŠ¤ ëˆ„ë¥´ë©´ -> í•´ë‹¹ í•™ë…„ì˜ ë°˜ ëª¨ë‘ ì„ íƒ/í•´ì œ
    function toggleGrade(grade) {
        const parent = document.getElementById('g_' + grade);
        const children = document.querySelectorAll('.child-g-' + grade);
        children.forEach(cb => {
            cb.checked = parent.checked;
        });
    }
    // ê²°ì‹œ ì‚¬ìœ  ì €ì¥ ìŠ¤í¬ë¦½íŠ¸
    function updateAbsence(studentId, activityId, value) {
        // ì„œë²„ë¡œ ì „ì†¡ (AJAX)
        fetch('/activities/api/update-absence/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'student_id': studentId,
                'activity_id': activityId,
                'value': value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // ì„±ê³µ ì‹œ ê¹œë¹¡ì„ íš¨ê³¼ (ì„ íƒ ì‚¬í•­)
                // alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); // ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ê·€ì°®ìœ¼ë‹ˆ ìƒëµ
                
                // ë§Œì•½ 'ê²°ì‹œ'ë¥¼ ì„ íƒí•˜ë©´ ìƒíƒœ ë±ƒì§€ë¥¼ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ DOM ì¡°ì‘ í•„ìš”
                // í•˜ì§€ë§Œ ê°„ë‹¨í•˜ê²ŒëŠ” ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜, ê·¸ëƒ¥ ë‘¡ë‹ˆë‹¤.
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
            }
        });
    }
</script>
{% endblock %}