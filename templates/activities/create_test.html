{% extends 'base.html' %}

{% block content %}
<!-- [ìŠ¤íƒ€ì¼ ì¶”ê°€] 5ì—´ ì„¸ë¡œ ë°°ì¹˜ ë° ì ‘ê¸°/í¼ì¹˜ê¸° ë””ìì¸ -->
<style>
    /* í•™ìƒ ëª…ë‹¨ ì„¸ë¡œ íë¦„ ë°°ì¹˜ (5ì—´) */
    .student-grid-container {
        column-count: 5;       /* 5ê°œì˜ ì—´ë¡œ ë‚˜ëˆ” */
        column-gap: 1rem;      /* ì—´ ì‚¬ì´ ê°„ê²© */
        column-rule: 1px solid #eee; /* ì—´ ì‚¬ì´ êµ¬ë¶„ì„  (ì„ íƒ) */
    }
    .student-item {
        break-inside: avoid;   /* ì´ë¦„ì´ ì—´ ì‚¬ì´ì—ì„œ ì˜ë¦¬ì§€ ì•Šê²Œ í•¨ */
        margin-bottom: 0.5rem; /* í•™ìƒ ê°„ ê°„ê²© */
    }
    
    /* ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .toggle-btn {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .toggle-btn:hover {
        background-color: #f8f9fa;
    }
    /* ì²´í¬ë°•ìŠ¤ì™€ ë¼ë²¨ ì •ë ¬ */
    .form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <!-- action ë³€ìˆ˜ì— ë”°ë¼ ì œëª© ë³€ê²½ (ìƒì„±/ìˆ˜ì •) -->
            <h3 class="fw-bold text-primary mb-0">ğŸ“ í…ŒìŠ¤íŠ¸ ì‹œíŠ¸ {{ action }}</h3>
        </div>
        
        <div class="card-body p-5">
            <form method="post">
                {% csrf_token %}
                
                <!-- [ìˆ˜ì •] í‰ê°€ ëŒ€ìƒ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                <div class="row mb-4 align-items-center">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        í‰ê°€ ëŒ€ìƒ <span class="text-danger">*</span>
                    </label>
                    <div class="col-md-9">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center" 
                                    type="button" id="targetDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                <span id="targetSummary">
                                    {% if current_targets %}
                                        {{ current_targets|length }}ëª… ì„ íƒë¨
                                    {% else %}
                                        í‰ê°€ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš” (í´ë¦­í•˜ì—¬ ëª…ë‹¨ ì—´ê¸°)
                                    {% endif %}
                                </span>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            
                            <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
                            <div class="dropdown-menu w-100 p-3 shadow" style="max-height: 600px; overflow-y: auto;">
                                
                                <!-- ì „ì²´ ì„ íƒ / í•´ì œ ë²„íŠ¼ -->
                                <div class="d-flex gap-2 mb-3 border-bottom pb-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary w-50 fw-bold" onclick="toggleAllStudents(true)">
                                        <i class="bi bi-check-all"></i> ì „êµìƒ ì„ íƒ
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary w-50" onclick="toggleAllStudents(false)">
                                        <i class="bi bi-x-circle"></i> ì„ íƒ í•´ì œ
                                    </button>
                                </div>

                                <!-- íŠ¸ë¦¬ êµ¬ì¡° ì‹œì‘ -->
                                {% for grade_info in student_tree %}
                                <div class="mb-2 border rounded p-2">
                                    <!-- 1. í•™ë…„ (í´ë¦­í•˜ë©´ ë°˜ ëª©ë¡ í† ê¸€) -->
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="form-check fw-bold text-primary mb-0">
                                            <input class="form-check-input parent-check" type="checkbox" id="g_{{ grade_info.grade }}" 
                                                onchange="toggleGroup(this, '.group-g-{{ grade_info.grade }}')">
                                            <label class="form-check-label" for="g_{{ grade_info.grade }}">
                                                {{ grade_info.grade }}í•™ë…„
                                            </label>
                                        </div>
                                        <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ì•„ì´ì½˜ -->
                                        <i class="bi bi-caret-down-fill text-muted toggle-btn p-1" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse-grade-{{ grade_info.grade }}"></i>
                                    </div>
                                    
                                    <!-- ë°˜ ëª©ë¡ ì»¨í…Œì´ë„ˆ (ê¸°ë³¸ì ìœ¼ë¡œ í¼ì³ë‘  'show', ë‹«ê³  ì‹¶ìœ¼ë©´ 'show' ì œê±°) -->
                                    <div class="collapse show ms-2 mt-2 border-top pt-2" id="collapse-grade-{{ grade_info.grade }}">
                                        {% for class_info in grade_info.classes %}
                                        <div class="mb-3">
                                            <!-- 2. ë°˜ (í´ë¦­í•˜ë©´ í•™ìƒ ëª©ë¡ í† ê¸€) -->
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <div class="form-check fw-bold text-dark mb-0">
                                                    <input class="form-check-input group-check group-g-{{ grade_info.grade }}" 
                                                        type="checkbox" id="c_{{ grade_info.grade }}_{{ class_info.class_no }}"
                                                        onchange="toggleGroup(this, '.child-c-{{ grade_info.grade }}-{{ class_info.class_no }}')">
                                                    <label class="form-check-label" for="c_{{ grade_info.grade }}_{{ class_info.class_no }}">
                                                        {{ class_info.class_no }}ë°˜ ({{ class_info.students|length }}ëª…)
                                                    </label>
                                                </div>
                                                <!-- ë°˜ë³„ ì ‘ê¸°/í¼ì¹˜ê¸° ì•„ì´ì½˜ -->
                                                <i class="bi bi-caret-down text-muted toggle-btn p-1" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse-class-{{ grade_info.grade }}-{{ class_info.class_no }}"></i>
                                            </div>

                                            <!-- 3. í•™ìƒ ëª…ë‹¨ (5ì—´ ì„¸ë¡œ ë°°ì¹˜) -->
                                            <div class="collapse show ps-2" id="collapse-class-{{ grade_info.grade }}-{{ class_info.class_no }}">
                                                <div class="student-grid-container">
                                                    {% for s in class_info.students %}
                                                    <div class="student-item form-check">
                                                        <input class="form-check-input student-check child-c-{{ grade_info.grade }}-{{ class_info.class_no }} group-g-{{ grade_info.grade }}" 
                                                            type="checkbox" name="target_students" value="{{ s.id }}" id="s_{{ s.id }}"
                                                            onchange="updateSummary()"
                                                            {% if s.id in current_targets %}checked{% endif %}>
                                                        
                                                        <!-- â˜… ë²ˆí˜¸ 2ìë¦¬ í¬ë§·íŒ… & ì´ë¦„ -->
                                                        <label class="form-check-label small text-secondary" for="s_{{ s.id }}" style="white-space: nowrap;">
                                                            <span class="fw-bold text-dark">{{ s.number|stringformat:"02d" }}</span> {{ s.name }}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê³¼ëª©ëª… -->
                <div class="row mb-4 align-items-center">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        ê³¼ëª©ëª… <span class="text-danger">*</span>
                    </label>
                    <div class="col-md-9">
                        {{ a_form.subject_name }} <!-- ì§ì ‘ ì…ë ¥ í•„ë“œ -->
                    </div>
                </div>

                <!-- í‰ê°€ ì˜ì—­ëª… -->
                <div class="row mb-4 align-items-center">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        í‰ê°€ì˜ì—­ëª… <span class="text-danger">*</span>
                    </label>
                    <div class="col-md-9">
                        {{ a_form.section }} <!-- forms.py ìœ„ì ¯ ì ìš©ë¨ -->
                    </div>
                </div>

                <!-- í‰ê°€ ì£¼ì œ -->
                <div class="row mb-4 align-items-center">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        í‰ê°€ ì£¼ì œ <span class="text-danger">*</span>
                    </label>
                    <div class="col-md-9">
                        {{ a_form.title }}
                    </div>
                </div>

                <!-- í‰ê°€ ë¬¸í•­ -->
                <div class="row mb-4">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2 h-100">
                        í‰ê°€ ë¬¸í•­ <span class="text-danger">*</span>
                    </label>
                    <div class="col-md-9">
                        {{ q_form.content }}
                        <div class="form-text">í•™ìƒì´ ë‹µí•´ì•¼ í•  ì§ˆë¬¸ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                <!-- ì°¸ê³  ìë£Œ -->
                <div class="row mb-4">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        ì°¸ê³  ìë£Œ
                    </label>
                    <div class="col-md-9">
                        {{ q_form.reference }}
                    </div>
                </div>

                <!-- ì‘ì„± ì¡°ê±´ -->
                <div class="row mb-4">
                    <label class="col-md-3 col-form-label fw-bold bg-light text-center border rounded py-2">
                        ì‘ì„± ì¡°ê±´
                    </label>
                    <div class="col-md-9">
                        {{ q_form.conditions }}
                    </div>
                </div>

                <!-- ì‘ì„± ë¶„ëŸ‰ -->
                <div class="row mb-4 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">ì‘ì„± ë¶„ëŸ‰</div>
                    <div class="col-md-9 px-4 d-flex align-items-center gap-2">
                        <input type="number" name="char_limit" class="form-control border-0 shadow-sm" 
                            style="width: 100px;" value="{{ activity.char_limit|default:0 }}">
                        <span class="fw-bold">ì ì´ìƒ</span>
                        <small class="text-muted ms-3">(ì œí•œì´ ì—†ìœ¼ë©´ 0 ë˜ëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ë‘ì„¸ìš”)</small>
                    </div>
                </div>

                <!-- ì‘ì‹œ í™˜ê²½ ìœ í˜• -->
                <div class="row mb-4 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">ì‘ì‹œ í™˜ê²½ ìœ í˜•</div>
                    <div class="col-md-9 px-4">
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exam_mode" id="mode_closed" value="CLOSED" 
                                    {% if not activity.exam_mode or activity.exam_mode == 'CLOSED' %}checked{% endif %}>
                                <label class="form-check-label" for="mode_closed">
                                    <span class="badge bg-danger mb-1">íì‡„í˜•</span><br>
                                    <small class="text-muted">í™”ë©´ ì´íƒˆ ê°ì§€, ìš°í´ë¦­/ë³µì‚¬ ê¸ˆì§€</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exam_mode" id="mode_open" value="OPEN"
                                    {% if activity.exam_mode == 'OPEN' %}checked{% endif %}>
                                <label class="form-check-label" for="mode_open">
                                    <span class="badge bg-primary mb-1">ê°œë°©í˜•</span><br>
                                    <small class="text-muted">ììœ ë¡œìš´ í™”ë©´ ì „í™˜ ë° ìë£Œ ì°¸ê³  í—ˆìš©</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="d-flex justify-content-center gap-2 mt-5">
                    <a href="{% url 'activity_list' %}" class="btn btn-secondary btn-lg px-4">ì·¨ì†Œ</a>
                    <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold">í‰ê°€ {{ action }} ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- íŠ¸ë¦¬ ì²´í¬ë°•ìŠ¤ ì œì–´ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // 1. ê·¸ë£¹ ì„ íƒ (í•™ë…„/ë°˜ ì²´í¬ ì‹œ í•˜ìœ„ ëª¨ë‘ ì²´í¬)
    function toggleGroup(parent, selector) {
        const children = document.querySelectorAll(selector);
        children.forEach(cb => {
            cb.checked = parent.checked;
        });
        updateSummary();
    }

    // 2. ìš”ì•½ ë¬¸êµ¬ ì—…ë°ì´íŠ¸ (ëª‡ ëª… ì„ íƒë¨)
    function updateSummary() {
        const count = document.querySelectorAll('.student-check:checked').length;
        const summary = document.getElementById('targetSummary');
        if (count > 0) {
            summary.innerText = `${count}ëª… ì„ íƒë¨`;
            summary.className = "text-primary fw-bold";
        } else {
            summary.innerText = "í‰ê°€ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”";
            summary.className = "text-muted";
        }
    }

    // ì „ì²´ ì„ íƒ/í•´ì œ í•¨ìˆ˜
    function toggleAllStudents(isChecked) {
        // ëª¨ë“  ì²´í¬ë°•ìŠ¤(í•™ë…„, ë°˜, í•™ìƒ)ë¥¼ ì°¾ì•„ì„œ ìƒíƒœ ë³€ê²½
        const allCheckboxes = document.querySelectorAll('.parent-check, .group-check, .student-check');
        allCheckboxes.forEach(cb => {
            cb.checked = isChecked;
        });
        updateSummary(); // ë¬¸êµ¬ ì—…ë°ì´íŠ¸
    }
    
    // ì´ˆê¸° ì‹¤í–‰ (ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê°œìˆ˜ í‘œì‹œ)
    updateSummary();
</script>
{% endblock %}