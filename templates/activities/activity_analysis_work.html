{% extends 'base.html' %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary"><i class="bi bi-cpu-fill"></i> 분석 작업: {{ activity.title }}</h3>
        <a href="{% url 'activity_list' %}" class="btn btn-secondary btn-sm">목록으로</a>
    </div>

    <div class="row">
        <!-- 1. 평가 상세 정보 (왼쪽) -->
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-bold">1. 평가 상세 정보 (가져올 내용)</div>
                <div class="card-body small" style="background-color: #fafafa;">
                    <div class="row mb-1">
                        <div class="col-4 text-muted">평가대상</div>
                        <div class="col-8">{{ activity.section }}</div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-4 text-muted">과목명</div>
                        <div class="col-8">{{ activity.subject_name }}</div>
                    </div>
                    <div class="row mb-1">
                        <div class="col-4 text-muted">평가주제</div>
                        <div class="col-8 fw-bold">{{ activity.title }}</div>
                    </div>
                    <hr>
                    <div class="mb-2">
                        <div class="text-muted mb-1">평가문항</div>
                        <div class="p-2 bg-white border rounded" style="max-height: 100px; overflow-y: auto;">{{ question.content }}</div>
                    </div>
                    <div class="mb-2">
                        <div class="text-muted mb-1">참고자료</div>
                        <div class="p-2 bg-white border rounded" style="max-height: 150px; overflow-y: auto;">{{ question.reference|default:"없음" }}</div>
                    </div>
                    <div class="mb-0">
                        <div class="text-muted mb-1">작성조건</div>
                        <div class="p-2 bg-white border rounded">{{ question.conditions|default:"없음" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 교사 기입 내용 (오른쪽) -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">2. 교사가 기입할 내용 (AI 지시사항)</div>
                <div class="card-body">
                    <!-- 템플릿 불러오기 -->
                    <div class="mb-3 p-2 bg-warning bg-opacity-10 border rounded">
                        <label class="small fw-bold text-warning-emphasis">프롬프트 예시 불러오기</label>
                        <select class="form-select form-select-sm" id="templateSelect" onchange="applyTemplate()">
                            <option value="">-- 예시 선택 --</option>
                            {% for t in prompt_templates %}<option value="{{ t.id }}">{{ t.title }}</option>{% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">활동의 맥락 및 AI의 역할</label>
                        <textarea id="p_context" class="form-control" rows="3" placeholder="예: 고등학교 1학년 역사 수업 시간임..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">AI가 수행할 작업</label>
                        <textarea id="p_task" class="form-control" rows="8" placeholder="예: 학생의 답안을 분석하여 생기부 문구로 변환해줘..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">창의성</label>
                            <input type="range" class="form-range" min="0.1" max="1.0" step="0.1" id="temperature" value="0.7">
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-primary fs-6 mt-3">대상 학생: {{ submit_count }}명</span>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="button" class="btn btn-success btn-lg fw-bold" onclick="runDBAnalysis()">
                            <i class="bi bi-play-circle-fill"></i> 분석 실행
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- (로딩 오버레이 코드는 ai_generator_step2.html과 동일하게 추가) -->
{% endblock %}

{% block extra_scripts %}
<script>
    // 템플릿 자동 채우기 로직 (기존 활용)
    // 분석 실행 로직 (AJAX 루프)
    async function runDBAnalysis() {
    if (answerList.length === 0) {
        alert("분석할 학생 답안이 없습니다.");
        return;
    }
    
    // 입력값들 가져오기
    const p_context = document.getElementById('p_context').value;
    const p_task = document.getElementById('p_task').value;
    const p_example = document.getElementById('p_example').value;
    const p_length = document.getElementById('p_length').value;
    const temperature = document.getElementById('temperature').value;
    
    // 최종 지시사항 조합
    const full_instruction = `
        [활동 맥락 및 역할]: ${p_context}
        [수행할 작업]: ${p_task}
        [원하는 결과 예시]: ${p_example}
        [분량 조건]: ${p_length}
    `;

    if (!confirm(`제출된 ${answerList.length}건의 답안을 Gemini 2.0 Flash로 분석하시겠습니까?`)) return;

    document.getElementById('loadingOverlay').classList.remove('d-none');

    for (let i = 0; i < answerList.length; i++) {
        const current = answerList[i];
        
        // UI 업데이트 (진행률 표시)
        document.getElementById('currentName').innerText = current.name;
        document.getElementById('currentCount').innerText = i + 1;
        const percent = Math.round(((i + 1) / answerList.length) * 100);
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressBar').innerText = percent + '%';

        try {
            const response = await fetch('/activities/api/process-db-row/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'answer_id': current.id,
                    'prompt_system': full_instruction,
                    'temperature': temperature,
                    'ai_model': 'gemini-2.0-flash'  // ★ 여기서 모델명을 명시해서 보냅니다.
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                console.error(`${current.name} 처리 중 오류: ${data.message}`);
            }

            // 구글 무료 티어 배려를 위한 1.2초 대기
            await new Promise(r => setTimeout(r, 1200));

        } catch (error) {
            console.error("통신 오류 발생:", error);
        }
    }

    document.getElementById('loadingOverlay').classList.add('d-none');
    alert("✅ 모든 분석이 완료되었습니다!");
    window.location.href = "{% url 'activity_analysis' activity.id %}";
}
</script>
{% endblock %}