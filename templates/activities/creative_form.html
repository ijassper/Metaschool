{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom">
            <h4 class="mb-0 fw-bold">ğŸ“ ì°½ì˜ì ì²´í—˜í™œë™ ì‹œíŠ¸ ìƒì„±</h4>
        </div>
        <div class="card-body bg-light-subtle p-4">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- ì…ë ¥ í–‰ ë°˜ë³µ -->
                <!-- í‰ê°€ëŒ€ìƒ ì»´í¬ë„ŒíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
                {% include 'components/student_selector.html' %}

                <div class="row mb-3 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">í™œë™ëª… *</div>
                    <div class="col-md-9 px-4">
                        <input type="text" name="section" value="{{ activity.section|default:'' }}" class="form-control" placeholder="í™œë™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">ì£¼ì œ *</div>
                    <div class="col-md-9 px-4">
                        <input type="text" name="title" value="{{ activity.title|default:'' }}" class="form-control" placeholder="ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 pt-3 text-center fw-bold text-secondary border-end">í‰ê°€ ë¬¸í•­ *</div>
                    <div class="col-md-9 px-4">
                        <textarea name="question" class="form-control border-0 shadow-sm" rows="6" placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required>{{ activity.question|default:'' }}</textarea>
                    </div>
                </div>

                <!-- ì œì¶œ ê¸°í•œ (ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ êµ¬í˜„) -->
                <div class="row mb-3 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end" required>ì œì¶œ ê¸°í•œ *</div>
                    <div class="col-md-9 px-4">
                        <div class="d-flex gap-2">
                            <div class="input-group shadow-sm border-0" style="width: 300px;">
                                <span class="input-group-text bg-white border-0"><i class="bi bi-calendar3"></i></span>
                                <input type="text" id="deadline_picker" name="deadline" value="{{ activity.deadline|date:'Y. m. d. A h:i' }}" class="form-control border-0 shadow-sm" placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{% if activity.deadline %}{{ activity.deadline|date:'Y. m. d. A h:i' }}{% endif %}" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 pt-3 text-center fw-bold text-secondary border-end">ì°¸ê³  ìë£Œ</div>
                    <div class="col-md-9 px-4">
                        <textarea name="reference_material" class="form-control border-0 shadow-sm mb-2" rows="6" placeholder="ì œì‹œë¬¸ ë˜ëŠ” ì°¸ê³  ìë£Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">{{ activity.reference_material|default:'' }}</textarea>
                        <!-- ì‹ ê·œ íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="input-group">
                            <label class="input-group-text bg-white border-0 shadow-sm" for="attachment">
                                <i class="bi bi-paperclip me-1"></i> íŒŒì¼ ì²¨ë¶€
                            </label>
                            <input type="file" name="attachment" class="form-control border-0 shadow-sm" id="attachment">
                        </div>
                        {% if activity.attachment %}
                            <div class="mt-1 ps-2">
                                <small class="text-primary fw-bold">
                                    <i class="bi bi-file-earmark-check"></i> ê¸°ì¡´ íŒŒì¼: 
                                    <a href="{{ activity.attachment.url }}" target="_blank" class="text-decoration-none">
                                        {{ activity.attachment.name|cut:"activity_files/" }} <!-- ê²½ë¡œëª… ìƒëµí•˜ê³  íŒŒì¼ëª…ë§Œ í‘œì‹œ -->
                                    </a>
                                </small>
                            </div>
                        {% endif %}
                        <small class="text-muted ps-2 mt-1 d-block">â€» PDF, HWP, ì´ë¯¸ì§€ ë“± (ìµœëŒ€ 10MB)</small>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 pt-3 text-center fw-bold text-secondary border-end">ì‘ì„± ì¡°ê±´</div>
                    <div class="col-md-9 px-4">
                        <textarea name="conditions" class="form-control border-0 shadow-sm" rows="2" placeholder="ì˜ˆ: 3ë¬¸ë‹¨ìœ¼ë¡œ êµ¬ì„±, ë‘ê´„ì‹ ì‘ì„±">{{ activity.conditions|default:'' }}</textarea>
                    </div>
                </div>

                <div class="row mb-4 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">ì‘ì„± ë¶„ëŸ‰</div>
                    <div class="col-md-9 px-4 d-flex align-items-center gap-2">
                        <input type="number" name="char_limit" class="form-control border-0 shadow-sm" style="width: 100px;" value="{{ activity.char_limit|default:0 }}">
                        <span>ì ì´ìƒ</span>
                        <small class="text-muted ms-3">(ì œí•œì´ ì—†ìœ¼ë©´ 0 ë˜ëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ë‘ì„¸ìš”)</small>
                    </div>
                </div>

                <!-- [ì¶”ê°€] ì‘ì‹œ í™˜ê²½ ìœ í˜• ì„ íƒ -->
                <div class="row mb-4 align-items-center">
                    <div class="col-md-3 text-center fw-bold text-secondary border-end">ì‘ì‹œ í™˜ê²½ ìœ í˜•</div>
                    <div class="col-md-9 px-4">
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exam_mode" id="mode_closed" value="CLOSED" 
                                    {% if not activity.exam_mode or activity.exam_mode == 'CLOSED' %}checked{% endif %}>
                                <label class="form-check-label" for="mode_closed">
                                    <span class="badge bg-danger mb-1">íì‡„í˜•</span><br>
                                    <small class="text-muted">í™”ë©´ ì´íƒˆ ê°ì§€, ìš°í´ë¦­/ë³µì‚¬ ê¸ˆì§€</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exam_mode" id="mode_open" value="OPEN"
                                    {% if activity.exam_mode == 'OPEN' %}checked{% endif %}>
                                <label class="form-check-label" for="mode_open">
                                    <span class="badge bg-primary mb-1">ê°œë°©í˜•</span><br>
                                    <small class="text-muted">ì°¸ê³ ìë£Œ í™•ì¸ ë° ììœ ë¡œìš´ í™”ë©´ ì „í™˜ í—ˆìš©</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-5">
                    <button type="button" class="btn btn-secondary px-5 me-2 shadow" onclick="history.back()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary px-5 shadow">í™œë™ ìƒì„± ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Flatpickr (êµ¬ê¸€ ìŠ¤íƒ€ì¼ ë‹¬ë ¥ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script>
    // Flatpickr ì´ˆê¸°í™”
    const deadlineInput = document.getElementById('deadline_picker');

    flatpickr(deadlineInput, {
        enableTime: true,
        dateFormat: "Y. m. d. K h:i", // KëŠ” ì˜¤ì „/ì˜¤í›„ í‘œì‹œ (locale 'ko' ì„¤ì • ì‹œ)
        locale: "ko",
        time_24hr: false,
        minDate: "today",
        // defaultDate ì„¤ì •ì„ ì‚­ì œí•˜ê±°ë‚˜ ì•„ë˜ì²˜ëŸ¼ ì¡°ê±´ë¶€ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        // ë§Œì•½ inputì— ì´ë¯¸ ê°’ì´ ìˆë‹¤ë©´(ìˆ˜ì • ëª¨ë“œ), ê·¸ ê°’ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        defaultDate: deadlineInput.value ? deadlineInput.value : new Date().setHours(23, 59)
    });

    // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
    document.getElementById('attachment').onchange = function() {
        if(this.files[0].size > 10 * 1024 * 1024) { // 10MB ì œí•œ
            alert("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            this.value = "";
        };
    };

    document.querySelector('form').onsubmit = function(e) {
        // 1. í‰ê°€ ëŒ€ìƒ(í•™ìƒ) ì²´í¬
        const selectedStudents = document.querySelectorAll('input[name="target_students"]:checked');
        if (selectedStudents.length === 0) {
            alert("í‰ê°€ ëŒ€ìƒ í•™ìƒì„ ìµœì†Œ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
            // ë“œë¡­ë‹¤ìš´ì´ ë‹«í˜€ìˆë‹¤ë©´ ì‚¬ìš©ìê°€ ì•Œ ìˆ˜ ìˆê²Œ í¬ì»¤ìŠ¤ë‚˜ ì•Œë¦¼ì„ ì¤ë‹ˆë‹¤.
            document.getElementById('targetDropdown').focus();
            e.preventDefault(); // ì „ì†¡ ì¤‘ë‹¨
            return false;
        }

        // 2. í™œë™ëª… ì²´í¬
        const section = document.querySelector('input[name="section"]').value.trim();
        if (!section) {
            alert("í™œë™ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            e.preventDefault();
            return false;
        }

        // 3. ì£¼ì œ ì²´í¬
        const title = document.querySelector('input[name="title"]').value.trim();
        if (!title) {
            alert("ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            e.preventDefault();
            return false;
        }

        // 4. í‰ê°€ ë¬¸í•­ ì²´í¬ (ì´ì „ IntegrityError ë°©ì§€ í•µì‹¬)
        const question = document.querySelector('textarea[name="question"]').value.trim();
        if (!question) {
            alert("í‰ê°€ ë¬¸í•­ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            e.preventDefault();
            return false;
        }

        // 5. ì œì¶œ ê¸°í•œ ì²´í¬
        const deadline = document.getElementById('deadline_picker').value.trim();
        if (!deadline) {
            alert("ì œì¶œ ê¸°í•œì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            e.preventDefault();
            return false;
        }

        // ëª¨ë“  ê²€ì‚¬ í†µê³¼ ì‹œ ì „ì†¡ ì§„í–‰
        return true;
    };
</script>
{% endblock %}